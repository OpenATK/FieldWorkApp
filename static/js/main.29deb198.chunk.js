(this["webpackJsonpfield-work"]=this["webpackJsonpfield-work"]||[]).push([[0],{1028:function(e,t,n){"use strict";n.r(t);var a={};n.r(a),n.d(a,"state",(function(){return _e})),n.d(a,"actions",(function(){return De})),n.d(a,"onInitialize",(function(){return Ee}));var r={};n.r(r),n.d(r,"state",(function(){return Re})),n.d(r,"actions",(function(){return Pe})),n.d(r,"effects",(function(){return Le}));var o=n(0),c=n.n(o),s=n(28),i=n.n(s);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));n(598),n(599),n(600);var u,l,d=n(190),p=n(67),f=n(1),h=n.n(f),m=n(236),v=n(574),g=n(10),b=n.n(g),w=n(26),k=n(36),y={OPTIONS:{redirect:l="http://openatk.com/FieldWorkApp/oauth2/redirect.html",metadata:u="eyJqa3UiOiJodHRwczovL2lkZW50aXR5Lm9hZGEtZGV2LmNvbS9jZXJ0cyIsImtpZCI6ImtqY1NjamMzMmR3SlhYTEpEczNyMTI0c2ExIiwidHlwIjoiSldUIiwiYWxnIjoiUlMyNTYifQ.eyJyZWRpcmVjdF91cmlzIjpbImh0dHA6Ly9vcGVuYXRrLmNvbS9GaWVsZFdvcmtBcHAvb2F1dGgyL3JlZGlyZWN0Lmh0bWwiLCJodHRwOi8vbG9jYWxob3N0L29hdXRoMi9yZWRpcmVjdC5odG1sIl0sInRva2VuX2VuZHBvaW50X2F1dGhfbWV0aG9kIjoidXJuOmlldGY6cGFyYW1zOm9hdXRoOmNsaWVudC1hc3NlcnRpb24tdHlwZTpqd3QtYmVhcmVyIiwiZ3JhbnRfdHlwZXMiOlsiYXV0aG9yaXphdGlvbl9jb2RlIl0sInJlc3BvbnNlX3R5cGVzIjpbInRva2VuIiwiY29kZSIsImlkX3Rva2VuIiwiaWRfdG9rZW4gdG9rZW4iLCJjb2RlIGlkX3Rva2VuIiwiY29kZSB0b2tlbiIsImNvZGUgaWRfdG9rZW4gdG9rZW4iXSwiY2xpZW50X25hbWUiOiJPcGVuQVRLIiwiY2xpZW50X3VyaSI6Imh0dHA6Ly9vcGVuYXRrLmNvbSIsImNvbnRhY3RzIjpbIlNhbSBOb2VsIDxzYW5vZWxAcHVyZHVlLmVkdT4iXSwiandrcyI6eyJrZXlzIjpbeyJrdHkiOiJSU0EiLCJuIjoiemF1WkZCdU1kbHYxa1lqelViNHEtXzNtNHNtRnhuZnc0U1lvYUhxN2NpOFNjdFkzeGo3cmRBSHlrUXBuUVZyajZLTzhtYUh2LTBCdlc1TWhjZ2l2a3VZcy16SEV2ZllCZVZCbmN2SGdPa0pQYmM5MUN3X2l3T1k3RUhXQjhoTTdWaUxRVmNfRHYwaDhuSnliQnZoTDA0Q0hRdDdDcE10VllHNmZvSlhjM2RxNTJqTlFiQkhJWjVtN1Z6MUt0eXpvTGNwOE8ybWhhTHA0NVVyM0NfMWVHdHY4bjVOejliV19CaDVYRlliRHh2N0JuaFpOSXcxR0NiampBd210Ym5uTDdHZ2Y0Q3k2MHdSSG1SNHZvZTIxT0lqb0FTcTJqWjAzeDEybVhzN0hQSTNZQjR5Mjl3dlpNdzJnTHpPZFRvcnJxTy10bG1uMWJvUGtXS0pKU1hvQXZ3IiwiZSI6IkFRQUIifV19LCJzb2Z0d2FyZV9pZCI6ImE3MDNiZmRjLTNmYTEtNDk5Zi1iOTA1LTExZjBiNTRmMzgwNyIsInJlZ2lzdHJhdGlvbl9wcm92aWRlciI6Imh0dHBzOi8vaWRlbnRpdHkub2FkYS1kZXYuY29tIiwiaWF0IjoxNTMzODQ2MTEyfQ.Y9BlbqHzOvufADGAW9HG4Yx2rqbg6zPalpcjSS_97Mpg36lOuADGJ4YTQ2iQfRlZjzqBi1sUq3iFhReBfk89Oy2nSEY6RVPnONK5v6a73jce3xGPUWk8DDl3rf3lcrt-IqWFoAieUie7WK5nrPFIe-_xcgYdChnuGrugjO9dGOY",scope:"oada.yield:all"},REDIRECT:l,METADATA:u,SCOPE:"oada.yield:all",oadaDomain:""},x={domain:y.oadaDomain},O={onInitialize:function(e){var t=e.state,n=e.actions,a=window.localStorage["oada:domain"],r=window.localStorage["oada:token"];a&&(t.view.Login.domain=a),a&&r&&n.view.Login.login({token:r})},login:function(e,t){return Object(w.a)(b.a.mark((function n(){var a,r,o,c,s;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=e.state,r=e.actions,o=t.token,c=a.view.Login,s=c.domain,c.loading=!0,s=s.match(/^http/)?s:"https://"+c.domain,n.next=8,r.app.OADAManager.login({domain:s,token:o});case 8:c.loading=!1,a.app.OADAManager.connected&&(c.loggedIn=!0,window.localStorage["oada:domain"]=c.domain,window.localStorage["oada:token"]=a.app.OADAManager.token);case 10:case"end":return n.stop()}}),n)})))()},logout:function(e){return Object(w.a)(b.a.mark((function t(){var n,a,r;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.state,a=e.actions,r=n.view.Login,!n.app.OADAManager.connected){t.next=7;break}return t.next=5,a.app.OADAManager.logout();case 5:delete window.localStorage["oada:domain"],delete window.localStorage["oada:token"];case 7:r.loggedIn=!1;case 8:case"end":return t.stop()}}),t)})))()},domainChange:function(e,t){e.state.view.Login.domain=t.value},viewDemo:function(e,t){e.state.view.Login.loggedIn=!0}},_=n(66),D=n(239),E=n.n(D),A={open:!1,fieldId:function(e,t){return Object(_.a)(e),h.a.get(t,"view.Map.selectedField")},field:function(e,t){var n=e.fieldId,a=h.a.get(t,"view.TopBar.OperationDropdown.selectedOperation");if(null==n)return null;var r=h.a.get(a,"fields.".concat(n,".status"),null),o=null;if(1==h.a.get(t,"app.OADAManager.connected")){var c=h.a.get(t,"app.OADAManager.currentConnection");o=h.a.get(t,"app.oada.".concat(c,".bookmarks.seasons.2019.fields.").concat(n))}else o=h.a.get(t,"app.localData.abc123.seasons.2019.fields.".concat(n));if(null==o)return null;var s=247105e-9*E.a.geometry(o.boundary);return h.a.merge({},o,{status:r,acres:s})},farm:function(e,t){var n=e.field,a=null;if(1==h.a.get(t,"app.OADAManager.connected")){var r=h.a.get(t,"app.OADAManager.currentConnection");if(h.a.get(n,"farm._id")){var o=h.a.get(t,"app.oadaSeasonFarmsIdBy_id.".concat(h.a.get(n,"farm._id"),".id"));a=h.a.get(t,"app.oada.".concat(r,".bookmarks.seasons.2019.farms.").concat(o))}}else h.a.get(n,"farm.id")&&(a=h.a.get(t,"app.localData.abc123.seasons.2019.farms.".concat(n.farm.id)));return a},showAddOperationButton:function(e,t){if(Object(_.a)(e),1==h.a.get(t,"app.OADAManager.connected")){var n=h.a.get(t,"app.OADAManager.currentConnection");return h.a.isEmpty(h.a.get(t,"app.oada.".concat(n,".bookmarks.seasons.2019.operations")))}return h.a.isEmpty(h.a.get(t,"app.localData.abc123.seasons.2019.operations"))}},j=n(49),M=n.n(j),C={bookmarks:{_type:"application/vnd.oada.bookmarks.1+json",_rev:0,fields:{_type:"application/vnd.oada.fields.1+json",_rev:0,fields:{"*":{_type:"application/vnd.oada.field.1+json",_rev:0,farm:{_type:"application/vnd.oada.farm.1+json"}}},farms:{"*":{_type:"application/vnd.oada.farm.1+json",_rev:0}}},seasons:{_type:"application/vnd.oada.seasons.1+json",_rev:0,"*":{_type:"application/vnd.oada.season.1+json",_rev:0,fields:{"*":{_type:"application/vnd.oada.field.1+json",_rev:0,operations:{"*":{_type:"application/vnd.oada.operation.1+json",_rev:0}}}},farms:{"*":{_type:"application/vnd.oada.farm.1+json",_rev:0}},operations:{"*":{_type:"application/vnd.oada.operation.1+json",_rev:0}}}}}},F=A,S={open:function(e){e.state.view.FieldDetails.open=!0},close:function(e){e.state.view.FieldDetails.open=!1},changeOADAFieldStatus:function(e,t){var n=e.state,a=e.actions,r=h.a.get(n,"view.Map.selectedField"),o=h.a.get(n,"view.TopBar.OperationDropdown.selectedOperationId"),c=h.a.get(n,"app.OADAManager.currentConnection"),s=h.a.clone(h.a.get(n,"app.oada.".concat(c,".bookmarks.seasons.2019.operations.").concat(o,".fields.").concat(r)))||{},i=t;if(s.status==t&&(i=null),s.status=i,null==s.status){h.a.unset(n,"app.oada.".concat(c,".bookmarks.seasons.2019.operations.").concat(o,".fields.").concat(r)),h.a.unset(n,"app.oada.".concat(c,".bookmarks.seasons.2019.fields.").concat(r,".operations.").concat(o));var u=[{type:"application/vnd.oada.operation.1+json",path:"/bookmarks/seasons/2019/operations/".concat(o,"/fields/").concat(r)},{type:"application/vnd.oada.field.1+json",path:"/bookmarks/seasons/2019/fields/".concat(r,"/operations/").concat(o)}];return a.app.oada.delete({requests:u,connection_id:c})}h.a.set(n,"app.oada.".concat(c,".bookmarks.seasons.2019.operations.").concat(o,".fields.").concat(r),s),null==h.a.get(n,"app.oada.".concat(c,".bookmarks.seasons.2019.fields.").concat(r,".operations"))&&h.a.set(n,"app.localData.abc123.seasons.2019.fields.".concat(r,".operations"),{}),h.a.set(n,"app.oada.".concat(c,".bookmarks.seasons.2019.fields.").concat(r,".operations.").concat(o),{});var l=h.a.get(n,"view.TopBar.OperationDropdown.selectedOperation"),d=[{tree:C,data:s,type:"application/vnd.oada.operation.1+json",path:"/bookmarks/seasons/2019/operations/".concat(o,"/fields/").concat(r)},{tree:C,data:{_id:l._id},type:"application/vnd.oada.field.1+json",path:"/bookmarks/seasons/2019/fields/".concat(r,"/operations/").concat(o)}];return a.app.oada.put({requests:d,connection_id:c})},changeLocalFieldStatus:function(e,t){var n=e.state,a=(n.view.FieldDetails,h.a.get(n,"view.Map.selectedField")),r=h.a.get(n,"view.TopBar.OperationDropdown.selectedOperationId"),o=h.a.clone(h.a.get(n,"app.localData.abc123.seasons.2019.operations.".concat(r,".fields.").concat(a)))||{},c=t;o.status==t&&(c=null),o.status=c,null==o.status?(h.a.unset(n,"app.localData.abc123.seasons.2019.operations.".concat(r,".fields.").concat(a)),h.a.unset(n,"app.localData.abc123.seasons.2019.fields.".concat(a,".operations.").concat(r))):(h.a.set(n,"app.localData.abc123.seasons.2019.operations.".concat(r,".fields.").concat(a),o),null==h.a.get(n,"app.localData.abc123.seasons.2019.fields.".concat(a,".operations"))&&h.a.set(n,"app.localData.abc123.seasons.2019.fields.".concat(a,".operations"),{}),h.a.set(n,"app.localData.abc123.seasons.2019.fields.".concat(a,".operations.").concat(r),{}))},onStatusChange:function(e,t){var n=e.state,a=e.actions,r=t.status,o=a.view.FieldDetails;n.app.OADAManager.connected?o.changeOADAFieldStatus(r):o.changeLocalFieldStatus(r)},onAddNewOperationClick:function(e){e.actions.view.TopBar.OperationDropdown.onAdd()}},I={open:!1,selectedField:null},N={},B={fieldStyles:{},selectedField:null,editingField:null,bounds:[[41.44053877385792,-84.97886180877687],[41.46330393671208,-84.96770381927492]],fields:function(e,t){Object(_.a)(e);var n=h.a.get(t,"view.Map.fieldStyles"),a=h.a.get(t,"view.Map.editingField"),r=(h.a.get(t,"view.Map.BoundaryDrawing.drawing"),h.a.get(t,"view.TopBar.OperationDropdown.selectedOperation")),o=h.a.get(t,"app.seasonFields");return h.a.chain(o).mapValues((function(e,t){if(a==t)return null;var o=h.a.clone(e);if(null!=n[t]&&(o.style=n[t]),r){var c="white";r.fields&&r.fields[t]&&("planned"==r.fields[t].status&&(c="red"),"started"==r.fields[t].status&&(c="orange"),"done"==r.fields[t].status&&(c="green")),o.style=h.a.merge({},o.style,{fillColor:c,color:c})}return o})).omitBy((function(e,t){if(null==e)return!0})).value()}},q=n(84),T=n.n(q),R=n(532),P=n.n(R),L=n(533),W=n.n(L),Z={styleField:{highlight:function(e,t){var n=e.state;if(t){var a=h.a.get(n,"view.Map");h.a.set(a,"fieldStyles.".concat(t),{weight:5})}},unhighlight:function(e,t){var n=e.state;if(t){var a=h.a.get(n,"view.Map");h.a.set(a,"fieldStyles.".concat(t),{weight:3})}}},unselectField:function(e){return Object(w.a)(b.a.mark((function t(){var n,a,r,o;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.state,a=e.actions,r=h.a.get(a,"view.Map"),!(o=h.a.get(n,"view.Map")).selectedField){t.next=9;break}return a.view.FieldDetails.close(),r.styleField.unhighlight(o.selectedField),t.next=8,T.a.delay(200);case 8:o.selectedField=null;case 9:case"end":return t.stop()}}),t)})))()},onFieldClick:function(e,t){var n=e.state,a=e.actions,r=t.id,o=h.a.get(a,"view.Map"),c=h.a.get(n,"view.Map");h.a.get(c,"BoundaryDrawing.drawing")||(o.styleField.unhighlight(c.selectedField),c.selectedField=r,o.styleField.highlight(r),a.view.FieldDetails.open())},onMapClick:function(e,t){var n=e.actions,a=h.a.get(n,"view.Map");a.unselectField(),a.BoundaryDrawing.onMapClick(t)},zoomBounds:function(e,t){return Object(w.a)(b.a.mark((function t(){var n,a,r,o,c;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=e.state,a=h.a.get(n,"view.Map"),r=h.a.compact(h.a.map(a.fields,(function(e){return e.boundary?{geo:e.boundary}:null}))),o=W.a.parse(r,{GeoJSON:"geo"}),c=P()(o),a.bounds=[[c[1],c[0]],[c[3],c[2]]];case 6:case"end":return t.stop()}}),t)})))()}},z=n(47),G={boundary:{},drawing:!1},V={addPointToBoundary:function(e,t){var n=e.state.view.Map.BoundaryDrawing;h.a.set(n,"boundary.".concat(M()()),[t.lat,t.lng])},updateBoundaryPoint:Object(z.h)(Object(z.d)(10),Object(z.g)((function(e,t){var n=e.state.view.Map.BoundaryDrawing;h.a.set(n,"boundary.".concat(t.id),[t.latlng.lat,t.latlng.lng])}))),onMapClick:function(e,t){var n=e.state,a=e.actions,r=t.lat,o=t.lng,c=n.view.Map.BoundaryDrawing,s=a.view.Map.BoundaryDrawing;c.drawing&&s.addPointToBoundary({lat:r,lng:o})},onMarkerMove:function(e,t){e.actions.view.Map.BoundaryDrawing.updateBoundaryPoint(t)},onStartDrawing:function(e,t){var n=e.state.view.Map.BoundaryDrawing;n.boundary=(t||{}).boundary||{},n.drawing=!0},onStopDrawing:function(e,t){var n=e.state.view.Map.BoundaryDrawing;n.drawing=!1,n.boundary={}}},H=Object(k.a)({BoundaryDrawing:G},B),Y=Object(k.a)({BoundaryDrawing:V},Z),U={OADADomain:{open:!1,domain:y.oadaDomain}},J={OADADomain:{open:function(e){e.state.view.Modals.OADADomain.open=!0},close:function(e){e.state.view.Modals.OADADomain.open=!1},onConnectClick:function(e){e.actions.view.Modals.OADADomain.open()},onDomainChange:function(e,t){var n=e.state,a=t.domain;n.view.Modals.OADADomain.domain=a},onConnect:function(e){return Object(w.a)(b.a.mark((function t(){var n,a,r,o,c;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.actions,a=e.state,r=a.view.Modals.OADADomain,o=n.view.Modals.OADADomain,c=r.domain,r.loading=!0,t.next=7,n.app.OADAManager.onDomainChanged({domain:c});case 7:r.loading=!1,o.close();case 9:case"end":return t.stop()}}),t)})))()},onCancel:function(e){e.actions.view.Modals.OADADomain.close()}}};function X(e){var t={type:"Polygon",coordinates:[h.a.map(e,(function(e){return[e[1],e[0]]}))]};return t.coordinates&&t.coordinates[0]&&t.coordinates[0].length>0&&t.coordinates[0].push(t.coordinates[0][0]),t}function Q(e,t){var n=e.state,a=e.actions,r=t.fieldId,o=t.newBoundary,c=t.farmId,s=t.farm_id,i=t.seasonFarm_id,u=n.view.Modals.SaveField,l=a.app.getSeasonField(r),d=u.name,p={},f={};return d!=l.name&&(p.name=d),0==h.a.isEqual(o,l.boundary)&&(p.boundary=o),f=h.a.cloneDeep(p),i?l.farm&&l.farm._id==i||(p.farm={_id:i},f.farm={_id:s}):l.farm&&l.farm.id==c||(p.farm={id:c},f.farm={id:c}),{fieldChanges:f,seasonFieldChanges:p}}function K(e,t,n,a){var r=e.state;if(!h.a.isEmpty(n)||!h.a.isEmpty(a)){var o="app.localData.abc123.fields.fields.".concat(t);h.a.set(r,o,h.a.merge({},h.a.get(r,o),n));var c="app.localData.abc123.seasons.2019.fields.".concat(t);h.a.set(r,c,h.a.merge({},h.a.get(r,c),a))}}function $(e,t,n,a){return ee.apply(this,arguments)}function ee(){return(ee=Object(w.a)(b.a.mark((function e(t,n,a,r){var o,c,s,i;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=t.state,c=t.actions,!h.a.isEmpty(a)||!h.a.isEmpty(r)){e.next=3;break}return e.abrupt("return");case 3:return s=[],0==h.a.isEmpty(a)&&s.push({tree:C,data:a,path:"/bookmarks/fields/fields/".concat(n)}),0==h.a.isEmpty(r)&&s.push({tree:C,data:r,path:"/bookmarks/seasons/2019/fields/".concat(n)}),console.log("fieldChanges",a),console.log("seasonFieldChanges",r),i=h.a.get(o,"app.OADAManager.currentConnection"),e.next=11,c.app.oada.put({requests:s,connection_id:i});case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function te(e,t){var n=t.boundary,a=t.farmId,r=t.farm_id;return{name:e.state.view.Modals.SaveField.name,boundary:n,farm:r?{_id:r}:{id:a}}}function ne(e,t){var n=t.field,a=e.state,r=M()();return h.a.set(a,"app.localData.abc123.fields.fields.".concat(r),n),h.a.set(a,"app.localData.abc123.seasons.2019.fields.".concat(r),Object(k.a)({},n,{operations:{},year:"2019"})),r}function ae(e,t){return re.apply(this,arguments)}function re(){return(re=Object(w.a)(b.a.mark((function e(t,n){var a,r,o,c,s,i,u;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.field,r=n.seasonField,o=t.state,c=t.actions,s=M()(),i=[],a&&i.push({tree:C,data:a,path:"/bookmarks/fields/fields/".concat(s)}),r&&i.push({tree:C,data:Object(k.a)({},r,{operations:{},year:"2019"}),path:"/bookmarks/seasons/2019/fields/".concat(s)}),u=h.a.get(o,"app.OADAManager.currentConnection"),e.next=9,c.app.oada.put({requests:i,connection_id:u});case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var oe={open:!1,name:"",farmSearch:"",farms:function(e,t){var n=e.farmSearch;return h.a.compact(h.a.map(t.app.seasonFarms,(function(e,t){return!e||""!=n&&e.name&&-1==e.name.toLowerCase().search(n.toLowerCase())?null:{key:t,text:e.name,value:t}})))},farmId:null,farm:function(e,t){var n=e.farmId;e.farms;if(n)return h.a.get(t,"app.seasonFarms.".concat(n))}},ce={open:function(e){var t=e.state,n=e.actions,a=t.view.Modals.SaveField,r=h.a.get(t,"view.Map.editingField");if(null==r)a.name="";else{var o=n.app.getSeasonField(r);if(a.name=o.name,t.app.OADAManager.connected){var c=h.a.get(t,"app.oadaSeasonFarmsIdBy_id.".concat(h.a.get(o,"farm._id"),".id"));a.farmId=c}else a.farmId=h.a.get(o,"farm.id")}a.open=!0},close:function(e){e.state.view.Modals.SaveField.open=!1},saveField:function(e){return Object(w.a)(b.a.mark((function t(){var n,a,r,o,c,s,i,u,l,d,p,f,m,v,g;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.state,a=n.view.Modals.SaveField,r=h.a.get(n,"view.Map.BoundaryDrawing.boundary"),o=X(r),c=a.farmId,s=null,i=null,(u=a.farm)&&n.app.OADAManager.connected&&(s=h.a.get(n,"app.oadaOrgData.fields.farms.".concat(c,"._id")),i=h.a.get(n,"app.seasonFarms.".concat(c,"._id"))),!(l=h.a.get(n,"view.Map.editingField"))){t.next=15;break}d=Q(e,{fieldId:l,newBoundary:o,farmId:c,farm_id:s,seasonFarm_id:i}),p=d.fieldChanges,f=d.seasonFieldChanges,n.app.OADAManager.connected?$(e,l,p,f):K(e,l,p,f),t.next=31;break;case 15:if(!n.app.OADAManager.connected){t.next=26;break}return t.next=18,te(e,{boundary:o,farm_id:s});case 18:return m=t.sent,t.next=21,te(e,{boundary:o,farm_id:i});case 21:return v=t.sent,t.next=24,ae(e,{field:m,seasonField:v});case 24:t.next=31;break;case 26:return t.next=28,te(e,{boundary:o,farm:u,farmId:c});case 28:return g=t.sent,t.next=31,ne(e,{field:g});case 31:case"end":return t.stop()}}),t)})))()},onSave:function(e){var t=e.actions,n=e.state,a=t.view.Modals.SaveField;a.saveField(),t.view.Map.BoundaryDrawing.onStopDrawing(),n.view.Map.editingField=null,a.close()},onCancel:function(e){var t=e.actions,n=e.state,a=t.view.Modals.SaveField;t.view.Map.BoundaryDrawing.onStopDrawing(),n.view.Map.editingField=null,a.close()},onNameChange:function(e,t){var n=e.state,a=t.name;n.view.Modals.SaveField.name=a},onFarmSearchChange:function(e,t){e.state.view.Modals.SaveField.farmSearch=t},onFarmChange:function(e,t){var n=e.state,a=t.id;n.view.Modals.SaveField.farmId=a},onFarmAdd:function(e){e.actions.view.Modals.NewFarm.open({callbackAction:"view.Modals.SaveField.onFarmAddComplete"})},onFarmAddComplete:function(e,t){var n=e.state,a=t.id;n.view.Modals.SaveField.farmId=a}};function se(e,t){var n=e.state,a=t.operation,r=M()();return h.a.set(n,"app.localData.abc123.seasons.2019.operations.".concat(r),a),r}function ie(e,t){return ue.apply(this,arguments)}function ue(){return(ue=Object(w.a)(b.a.mark((function e(t,n){var a,r,o,c,s,i,u,l;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.state,r=t.actions,o=n.operation,c=M()(),s=[{tree:C,data:o,path:"/bookmarks/seasons/2019/operations/".concat(c)}],i=h.a.get(a,"app.OADAManager.currentConnection"),e.next=7,r.app.oada.put({requests:s,connection_id:i});case 7:return u=e.sent,l=h.a.get(u,"responses.0.headers.content-location").substr(1),e.abrupt("return",{id:c,_id:l});case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var le={open:!1,name:""},de={open:function(e){var t=e.state.view.Modals.NewOperation;t.name="",t.open=!0},close:function(e){e.state.view.Modals.NewOperation.open=!1},saveOperation:function(e){return Object(w.a)(b.a.mark((function t(){var n,a,r,o,c,s;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.state,a=n.view.Modals.NewOperation,i={name:a.name},r={name:i.name,fields:{}},!n.app.OADAManager.connected){t.next=12;break}return t.next=6,ie(e,{operation:r});case 6:o=t.sent,c=o.id,o._id,h.a.set(n,"view.TopBar.OperationDropdown.selected",c),t.next=16;break;case 12:return t.next=14,se(e,{operation:r});case 14:s=t.sent,h.a.set(n,"view.TopBar.OperationDropdown.selected",s);case 16:case"end":return t.stop()}var i}),t)})))()},onNameChange:function(e,t){var n=e.state,a=t.name;n.view.Modals.NewOperation.name=a},onCancel:function(e){e.actions.view.Modals.NewOperation.close()},onSave:function(e){return Object(w.a)(b.a.mark((function t(){var n,a;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.actions,a=n.view.Modals.NewOperation,t.next=4,a.saveOperation();case 4:a.close();case 5:case"end":return t.stop()}}),t)})))()}};function pe(e,t){var n=t.farm,a=e.state,r=M()();return h.a.set(a,"app.localData.abc123.farms.".concat(r),n),h.a.set(a,"app.localData.abc123.seasons.2019.farms.".concat(r),n),r}function fe(e,t){return he.apply(this,arguments)}function he(){return(he=Object(w.a)(b.a.mark((function e(t,n){var a,r,o,c,s,i,u,l,d;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.farm,r=t.state,o=t.actions,c=M()(),s=[{tree:C,data:a,path:"/bookmarks/fields/farms/".concat(c)},{tree:C,data:a,path:"/bookmarks/seasons/2019/farms/".concat(c)}],i=h.a.get(r,"app.OADAManager.currentConnection"),e.next=7,o.app.oada.put({requests:s,connection_id:i});case 7:if(u=e.sent,null!=(l=h.a.get(u,"responses.0.headers.content-location").substr(1))){e.next=11;break}throw"OADA did not return an _id when creating a farm.";case 11:if(null!=(d=h.a.get(u,"responses.1.headers.content-location").substr(1))){e.next=14;break}throw"OADA did not return an _id when creating a season farm.";case 14:return e.abrupt("return",{farm_id:l,seasonFarm_id:d,id:c});case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var me={open:!1,name:""},ve={open:function(e,t){var n=e.state,a=t.callbackAction,r=n.view.Modals.NewFarm;r.name="",r.open=!0,r.callbackAction=a||null},close:function(e){e.state.view.Modals.NewFarm.open=!1},saveFarm:function(e){return Object(w.a)(b.a.mark((function t(){var n,a,r,o,c,s,i,u,l,d,p;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.state,a=e.actions,r=n.view.Modals.NewFarm,f={name:r.name},o={name:f.name},!n.app.OADAManager.connected){t.next=17;break}return t.next=6,fe(e,{farm:o});case 6:if(c=t.sent,s=c.farm_id,i=c.seasonFarm_id,u=c.id,!r.callbackAction){t.next=15;break}if(l=h.a.get(a,r.callbackAction)){t.next=14;break}throw"callbackAction: ".concat(r.callbackAction," does not exist.");case 14:l({farm_id:s,seasonFarm_id:i,id:u});case 15:t.next=25;break;case 17:return t.next=19,pe(e,{farm:o});case 19:if(d=t.sent,!r.callbackAction){t.next=25;break}if(p=h.a.get(a,r.callbackAction)){t.next=24;break}throw"callbackAction: ".concat(r.callbackAction," does not exist.");case 24:p({id:d});case 25:case"end":return t.stop()}var f}),t)})))()},onNameChange:function(e,t){var n=e.state,a=t.name;n.view.Modals.NewFarm.name=a},onCancel:function(e){e.actions.view.Modals.NewFarm.close()},onSave:function(e){return Object(w.a)(b.a.mark((function t(){var n,a;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.actions,a=n.view.Modals.NewFarm,t.next=4,a.saveFarm();case 4:a.close();case 5:case"end":return t.stop()}}),t)})))()}},ge=Object(k.a)({SaveField:oe,NewOperation:le,NewFarm:me},U),be=Object(k.a)({SaveField:ce,NewOperation:de,NewFarm:ve},J),we={onAddField:function(e){e.actions.view.Map.BoundaryDrawing.onStartDrawing()},onSaveField:function(e){e.actions.view.Modals.SaveField.open()},onCancelField:function(e){var t=e.state,n=e.actions;t.view.Map.editingField=null,n.view.Map.BoundaryDrawing.onStopDrawing()},onEditField:function(e){var t=e.actions,n=e.state,a=n.view.FieldDetails.field;n.view.Map.editingField=n.view.FieldDetails.fieldId;var r={},o=h.a.get(a,"boundary.coordinates.0");o.length>0&&o.pop(),h.a.forEach(o||[],(function(e){r[M()()]=[e[1],e[0]]})),t.view.Map.BoundaryDrawing.onStartDrawing({boundary:r}),t.view.Map.unselectField()},onResetCache:function(e){return Object(w.a)(b.a.mark((function t(){var n;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.actions,t.next=3,n.app.oada.resetCache();case 3:case"end":return t.stop()}}),t)})))()},onLogout:function(e){return Object(w.a)(b.a.mark((function t(){var n;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.actions,t.next=3,n.view.Login.logout();case 3:case"end":return t.stop()}}),t)})))()}},ke={open:!1,selected:null,search:"",list:function(e,t){var n=e.selected,a=e.operations,r=h.a.get(t,"view.TopBar.OperationDropdown.search");return h.a.omitBy(h.a.mapValues(a,(function(e,t){var a=e.name;return null==t||null==a||""!=r&&-1==a.search(r)?null:{text:a,value:t,selected:n==t,label:{color:"green",empty:!0,circular:!0}}})),h.a.isEmpty)},operations:function(e,t){Object(_.a)(e);var n=null;if(1==h.a.get(t,"app.OADAManager.connected")){var a=h.a.get(t,"app.OADAManager.currentConnection");n=h.a.omitBy(h.a.get(t,"app.oada.".concat(a,".bookmarks.seasons.2019.operations"))||{},(function(e,t){return h.a.startsWith(t,"_")}))}else n=h.a.get(t,"app.localData.abc123.seasons.2019.operations");return n},selectedOperationId:function(e,t){var n=e.selected,a=e.operations,r=n;return null==r&&h.a.keys(a).length>0&&(r=h.a.keys(a)[0]),r},selectedOperation:function(e,t){var n=e.selectedOperationId;return e.operations[n]}},ye={onAdd:function(e){var t=e.state,n=e.actions;return t.view.TopBar.OperationDropdown.open=!1,n.view.Modals.NewOperation.open()},onChange:function(e,t){var n=e.state,a=t.id,r=n.view.TopBar.OperationDropdown;r.selected=a,r.open=!1},onOpenChange:function(e,t){var n=e.state,a=t.open;n.view.TopBar.OperationDropdown.open=a},onSearch:function(e,t){var n=e.state,a=t.search;n.view.TopBar.OperationDropdown.search=a}},xe=Object(k.a)({OperationDropdown:ke},{}),Oe=Object(k.a)({OperationDropdown:ye},we),_e=Object(k.a)({Login:x,FieldDetails:F,FieldList:I,Map:H,Modals:ge,TopBar:xe},{}),De=Object(k.a)({Login:O,FieldDetails:S,FieldList:N,Map:Y,Modals:be,TopBar:Oe},{}),Ee=function(){var e=Object(w.a)(b.a.mark((function e(t){var n;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.actions,e.next=3,n.app.onInitialize();case 3:return e.next=5,n.view.Login.onInitialize();case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Ae={"42f60b10-784c-11ea-8dfd-a3e960f56105":{name:"1004 G-N",boundary:{type:"Polygon",coordinates:[[[-84.97584700584412,41.4628134964027],[-84.97539639472963,41.462765256171906],[-84.97495651245119,41.46275721612994],[-84.97424840927125,41.46250797433487],[-84.97405529022217,41.46203360827181],[-84.97410893440247,41.46044164256161],[-84.97139453887941,41.46130195211675],[-84.96770381927492,41.46327177680542],[-84.97010707855226,41.46330393671208],[-84.9764907360077,41.46306273702346],[-84.97634053230287,41.45965368547904],[-84.97462391853334,41.46024867436535],[-84.9746346473694,41.461004463187685],[-84.97491359710695,41.46126175098986],[-84.97492432594301,41.46172004235903],[-84.97529983520509,41.46208988917259],[-84.97581481933594,41.46234717266838],[-84.9761688709259,41.46278133625282]]]},farm:{id:"42f08cd0-784c-11ea-8dfd-a3e960f56105"}},"7c0ce950-784c-11ea-bfa5-97fea4f9bfd9":{name:"1001 HO-N",boundary:{type:"Polygon",coordinates:[[[-84.97347593307495,41.44864540647965],[-84.97626543045044,41.44856498851091],[-84.97617959976196,41.44784122230691],[-84.977445602417,41.44782513852177],[-84.97759580612183,41.44862932289387],[-84.97886180877687,41.448532821295515],[-84.97866868972778,41.44205080201176],[-84.97654438018799,41.442887227983185],[-84.97549295425415,41.44425443952937],[-84.97323989868165,41.44608806625952],[-84.97272491455078,41.44689227216232],[-84.97330427169801,41.44726220353039]]]},farm:{id:"42f08cd0-784c-11ea-8dfd-a3e960f56105"}},"8ab27420-784c-11ea-bfa5-97fea4f9bfd9":{name:"1002 HO-S",boundary:{type:"Polygon",coordinates:[[[-84.97152328491212,41.44697269220437],[-84.97148036956789,41.44166475561947],[-84.97152328491212,41.44111785263252],[-84.97347593307495,41.441085681725035],[-84.97373342514038,41.44073180069027],[-84.97635126113893,41.44053877385792],[-84.97645854949953,41.44134304853828],[-84.97607231140138,41.44161649965898],[-84.97611522674562,41.44240467585386],[-84.97540712356569,41.44398099952468]]]},farm:{id:"42f08cd0-784c-11ea-8dfd-a3e960f56105"}}},je={"42f08cd0-784c-11ea-8dfd-a3e960f56105":{name:"Bowman and Bowman"},"52f08cd0-784c-11ea-8dfd-a3e960f56105":{name:"Martz Farms"}},Me={acresStatus:function(e,t){Object(_.a)(e);var n=t.app.operationFields,a=t.app.seasonFields,r=0,o=0,c=0;h.a.forEach(n,(function(e,t){if(null!=e){var n=a[t];if(null!=n){var s=247105e-9*E.a.geometry(n.boundary);"planned"==e.status?r+=s:"started"==e.status?o+=s:"done"==e.status&&(c+=s)}}}));var s=r+o+c;return{planned:Math.round(r),plannedPercentage:Math.round(r/(s||1)*100),started:Math.round(o),startedPercentage:Math.round(o/(s||1)*100),done:Math.round(c),donePercentage:Math.round(c/(s||1)*100)}},seasonFarms:function(e,t){var n;if(Object(_.a)(e),1==h.a.get(t,"app.OADAManager.connected")){var a=h.a.get(t,"app.OADAManager.currentConnection");n=h.a.chain(t).get("app.oada.".concat(a,".bookmarks.seasons.2019.farms")).omitBy((function(e,t){return!!h.a.startsWith(t,"_")||(null==e||void 0)})).value()}else n=h.a.get(t,"app.localData.abc123.seasons.2019.farms");return n||{}},seasonFields:function(e,t){var n;if(Object(_.a)(e),1==h.a.get(t,"app.OADAManager.connected")){var a=h.a.get(t,"app.OADAManager.currentConnection");n=h.a.chain(t).get("app.oada.".concat(a,".bookmarks.seasons.2019.fields")).omitBy((function(e,t){return!!h.a.startsWith(t,"_")||(null==e||void 0)})).value()}else n=h.a.get(t,"app.localData.abc123.seasons.2019.fields");return n||{}},operationFields:function(e,t){Object(_.a)(e);var n=h.a.get(t,"view.TopBar.OperationDropdown.selectedOperationId"),a=[];if(null!=n)if(1==h.a.get(t,"app.OADAManager.connected")){var r=h.a.get(t,"app.OADAManager.currentConnection");a=h.a.get(t,"app.oada.".concat(r,".bookmarks.seasons.2019.operations.").concat(n,".fields"))||[]}else a=h.a.get(t,"app.localData.abc123.seasons.2019.operations.".concat(n,".fields"))||[];return a},currentOADA:function(e,t){if(Object(_.a)(e),t.app.OADAManager.connected){var n=t.app.OADAManager.currentConnection;if(!n)return;return t.app.oada[n]}},oadaOrgData:function(e){var t=e.currentOADA;if(t)return t.bookmarks},oadaSeasonFarmsIdBy_id:function(e,t){var n=e.oadaOrgData;return h.a.chain(n).get("seasons.2019.farms").mapValues((function(e,t){return e?{_id:e._id,id:t}:null})).omitBy(h.a.isNull).mapKeys((function(e,t){return e._id})).value()},oadaSeasonFarms_idByFarm_id:function(e,t){var n=e.oadaOrgData;return h.a.chain(n).get("fields.farms").mapValues((function(e,t){return e?{seasonFarm_id:h.a.get(n,"seasons.2019.farms.".concat(t,"._id")),farm_id:e._id}:null})).omitBy(h.a.isNull).mapKeys((function(e,t){return e.farm_id})).value()},localOrgData:function(e){return e.localData.abc123},localData:{organizations:{abc123:{name:"Default"}},abc123:{fields:{fields:Object(k.a)({},Ae),farms:Object(k.a)({},je)},seasons:{2019:{fields:Object(k.a)({},Ae),farms:Object(k.a)({},je),operations:{}}}}}},Ce={getSeasonField:function(e,t){var n=e.state,a=[];if(1==h.a.get(n,"app.OADAManager.connected")){var r=h.a.get(n,"app.OADAManager.currentConnection");a=h.a.get(n,"app.oada.".concat(r,".bookmarks.seasons.2019.fields"))}else a=h.a.get(n,"app.localData.abc123.seasons.2019.fields");return a[t]},getSeasonFarm:function(e,t){var n=e.state,a=[];if(1==h.a.get(n,"app.OADAManager.connected")){var r=h.a.get(n,"app.OADAManager.currentConnection");a=h.a.get(n,"app.oada.".concat(r,".bookmarks.seasons.2019.farms"))}else a=h.a.get(n,"app.localData.abc123.seasons.2019.farms");return a[t]},onInitialize:function(e){e.state;e.actions.view.Map.zoomBounds()}},Fe={connected:!1,currentConnection:null,domain:null,token:null,user:function(e,t){return e.currentConnection?h.a.get(t,"app.oada.localhost.users.me"):null}},Se=n(534),Ie=T.a.promisify(Se.browser.getAccessToken),Ne=Fe,Be={getToken:function(e,t){return Object(w.a)(b.a.mark((function n(){var a,r,o;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a=e.state,!(r=a.app.OADAManager).token){n.next=4;break}return n.abrupt("return",r.token);case 4:return n.next=6,Ie(t.replace(/^https?:\/\//,""),{metadata:y.METADATA,scope:y.SCOPE,redirect:y.REDIRECT});case 6:return o=n.sent,n.abrupt("return",o.access_token);case 8:case"end":return n.stop()}}),n)})))()},connect:function(e,t){return Object(w.a)(b.a.mark((function n(){var a,r,o,c,s,i;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=e.actions,r=e.state,e.effects,o=t.domain,c=t.token,s=r.app.OADAManager,i=a.app.OADAManager,c&&(s.token=c),n.next=7,i.getToken(o);case 7:return c=n.sent,n.abrupt("return",a.app.oada.connect({token:c,domain:o,options:y.OPTIONS,cache:!1}).then((function(e){return e.error||(s.currentConnection=e.connectionId,s.token=e.token,s.connected=!0,r.view.TopBar.OperationDropdown.selected=null),e})));case 9:case"end":return n.stop()}}),n)})))()},logout:function(e){return Object(w.a)(b.a.mark((function t(){var n,a,r,o;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.actions,a=e.state,r=a.app.OADAManager,o=r.currentConnection,r.token=null,t.next=6,n.app.oada.disconnect({connection_id:o});case 6:case"end":return t.stop()}}),t)})))()},getUserInfo:function(e){return Object(w.a)(b.a.mark((function t(){var n,a,r,o,c;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.actions,a=e.state,r=a.app.OADAManager,o=r.currentConnection,c=[{path:"/users/me"}],t.next=6,n.app.oada.get({requests:c,connection_id:o});case 6:case"end":return t.stop()}}),t)})))()},fetchAndWatch:function(e){return Object(w.a)(b.a.mark((function t(){var n,a,r,o,c,s,i,u,l;return b.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.actions,a=e.state,r=a.app.OADAManager,o=r.currentConnection,c=[{path:"/bookmarks/fields",tree:C,watch:{actions:[n.app.OADAManager.onFieldChanged]}},{path:"/bookmarks/seasons",tree:C,watch:{actions:[n.app.OADAManager.onSeasonsChanged]}}],t.next=6,n.app.oada.get({requests:c,connection_id:o});case 6:if(s=t.sent,i=[],console.log("SOMETIMES ERRORS:",s),!s.responses[0].error){t.next=16;break}if(404==s.responses[0].status){t.next=12;break}throw s.responses[0].error;case 12:return u=[{tree:C,data:{fields:{},farms:{}},path:"/bookmarks/fields"}],t.next=15,n.app.oada.put({requests:u,connection_id:o});case 15:i.push(c[0]);case 16:if(!s.responses[1].error){t.next=23;break}if(404==s.responses[1].status){t.next=19;break}throw s.responses[0].error;case 19:return l=[{tree:C,data:{},path:"/bookmarks/seasons"}],t.next=22,n.app.oada.put({requests:l,connection_id:o});case 22:i.push(c[1]);case 23:if(!(i.length>0)){t.next=26;break}return t.next=26,n.app.oada.get({requests:i,connection_id:o});case 26:case"end":return t.stop()}}),t)})))()},initSeasonFields:function(e){var t=e.state,n=e.actions.app.OADAManager,a=[];return h.a.forEach(h.a.get(t,"app.oadaOrgData.fields.fields"),(function(e,t){h.a.startsWith(t,"_")||a.push({fieldId:t,name:e.name,boundary:e.boundary,farm:e.farm})})),n.changeSeasonFields(a)},initSeasonFarms:function(e){var t=e.state,n=e.actions.app.OADAManager,a=[];return h.a.forEach(h.a.get(t,"app.oadaOrgData.fields.farms"),(function(e,t){h.a.startsWith(t,"_")||a.push({farmId:t,name:e.name})})),n.changeSeasonFarms(a)},changeSeasonFields:function(e,t){return Object(w.a)(b.a.mark((function n(){var a,r,o,c,s,i;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a=e.state,r=e.actions,o=a.app.OADAManager,c=o.currentConnection,s=[],i=a.app.seasonFields,h.a.forEach(t,(function(e){if(null!=e.fieldId){var t={},n=i[e.fieldId];if(e.name&&(null!=n&&n.name==e.name||(t.name=e.name)),e.boundary&&(null!=n&&0!=h.a.isEqual(n.boundary,e.boundary)||(t.boundary=e.boundary)),e.farm){var r=h.a.get(e,"farm._id");if(r){var o=h.a.get(a,"app.oadaSeasonFarms_idByFarm_id.".concat(r,".seasonFarm_id"));o?(null==n||null==n.farm||null==n.farm._id||null!=o&&n.farm._id!=o)&&(t.farm=h.a.merge({},t.farm,{_id:o})):console.log("No matching season farm found for farmId:",r,"Cannot check if season fields farm has changed. Data:",e)}}h.a.isEmpty(t)||s.push({tree:C,data:t,type:"application/vnd.oada.field.1+json",path:"/bookmarks/seasons/2019/fields/".concat(e.fieldId)})}})),0!=s.length){n.next=8;break}return n.abrupt("return");case 8:return n.next=10,r.app.oada.put({requests:s,connection_id:c});case 10:case"end":return n.stop()}}),n)})))()},changeSeasonFarms:function(e,t){return Object(w.a)(b.a.mark((function n(){var a,r,o,c,s,i;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a=e.state,r=e.actions,o=a.app.OADAManager,c=o.currentConnection,s=[],i=a.app.seasonFarms,h.a.forEach(t,(function(e){if(null!=e.farmId){var t={},n=i[e.farmId];e.name&&(null!=n&&n.name==e.name||(t.name=e.name)),h.a.isEmpty(t)||s.push({tree:C,data:t,type:"application/vnd.oada.farm.1+json",path:"/bookmarks/seasons/2019/farms/".concat(e.farmId)})}})),0!=s.length){n.next=8;break}return n.abrupt("return");case 8:return n.next=10,r.app.oada.put({requests:s,connection_id:c});case 10:case"end":return n.stop()}}),n)})))()},deleteSeasonFields:function(e,t){return Object(w.a)(b.a.mark((function n(){var a,r,o,c,s,i;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a=e.state,r=e.actions,console.log("delete season fields",t),o=a.app.OADAManager,c=o.currentConnection,s=[],i=a.app.seasonFields,h.a.forEach(t,(function(e){i[e]&&s.push({tree:C,type:"application/vnd.oada.field.1+json",path:"/bookmarks/seasons/2019/fields/".concat(e)})})),0!=s.length){n.next=9;break}return n.abrupt("return");case 9:return n.next=11,r.app.oada.delete({requests:s,connection_id:c});case 11:case"end":return n.stop()}}),n)})))()},deleteSeasonFarms:function(e,t){return Object(w.a)(b.a.mark((function n(){var a,r,o,c,s,i;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a=e.state,r=e.actions,console.log("delete season farms",t),o=a.app.OADAManager,c=o.currentConnection,s=[],i=a.app.seasonFarms,h.a.forEach(t,(function(e){i[e]&&s.push({tree:C,type:"application/vnd.oada.farm.1+json",path:"/bookmarks/seasons/2019/farms/".concat(e)})})),0!=s.length){n.next=9;break}return n.abrupt("return");case 9:return n.next=11,r.app.oada.delete({requests:s,connection_id:c});case 11:case"end":return n.stop()}}),n)})))()},login:function(e,t){return Object(w.a)(b.a.mark((function n(){var a,r,o,c,s,i,u;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=e.actions,r=e.state,o=t.domain,c=t.token,s=r.app.OADAManager,i=a.app.OADAManager,s.domain=o,n.next=7,i.connect({domain:o,token:c});case 7:if(u=n.sent,u.error){n.next=20;break}return n.next=12,i.getUserInfo();case 12:return n.next=14,i.fetchAndWatch();case 14:return n.next=16,i.initSeasonFarms();case 16:return n.next=18,i.initSeasonFields();case 18:return n.next=20,a.view.Map.zoomBounds();case 20:case"end":return n.stop()}}),n)})))()},onFieldChanged:function(e,t){return Object(w.a)(b.a.mark((function n(){var a,r,o,c,s,i,u,l,d;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:e.state,a=e.actions,console.log("onFieldChanged",t),r=a.app.OADAManager,"merge"==(o=h.a.get(t,"response.change.type"))||"delete"==o?(c=!1,s=h.a.get(t,"response.change.wasDelete"),("deleted"==o||s)&&(c=!0),i=[],u=[],h.a.forEach(h.a.get(t,"response.change.body.data.fields"),(function(e,n){"undefined"!=n?c?u.push(n):i.push({fieldId:n,deleted:c,name:h.a.get(e,"name"),boundary:h.a.get(e,"boundary")}):console.log("WARNING: Received a bad field change from OADA",t)})),u.length>0&&r.deleteSeasonFields(u),i.length>0&&r.changeSeasonFields(i),l=[],d=[],h.a.forEach(h.a.get(t,"response.change.body.data.farms"),(function(e,n){"undefined"!=n?c?d.push(n):l.push({farmId:n,deleted:c,name:h.a.get(e,"name")}):console.log("WARNING: Received a bad farm change from OADA",t)})),d.length>0&&r.deleteSeasonFarms(d),l.length>0&&r.changeSeasonFarms(l)):console.warn("onFieldChanged: Unsupported change type:",o);case 5:case"end":return n.stop()}}),n)})))()},onSeasonsChanged:function(e,t){e.state,e.actions}},qe=n(535),Te=n.n(qe)()("app.oada"),Re=Object(k.a)({oada:Te.state,OADAManager:Ne},Me),Pe=Object(k.a)({oada:Te.actions,OADAManager:Be},Ce),Le={oada:Te.effects},We=Object(v.a)({view:a,app:r}),Ze=Object(m.b)(),ze=n(1094),Ge=n(1074),Ve=n(1032);function He(){var e=Object(d.a)(["\n        position: absolute;\n        top: 10px;\n        right: 10px;\n        font-size: 1.2em;\n        color: #FFFFFF;\n        cursor: pointer;\n      "]);return He=function(){return e},e}function Ye(){var e=Object(d.a)(["\n          display: flex;\n          flex-direction: column;\n        "]);return Ye=function(){return e},e}function Ue(){var e=Object(d.a)(["\n        width: 400px;\n        display: flex;\n        flex-direction: column;\n        background: #fff;\n        padding: 15px;\n        padding-top: 7px;\n        border-radius: 5px;\n      "]);return Ue=function(){return e},e}function Je(){var e=Object(d.a)(["\n      height: 100vh;\n      width: 100vw;\n      display: flex;\n      flex-direction: column;\n      justify-content: center;\n      align-items: center;\n      background: url(imgs/login-background.jpg) no-repeat center center fixed;\n      background-size: cover;\n    "]);return Je=function(){return e},e}var Xe=function(){var e=Ze(),t=e.state,n=e.actions,a=t.view.Login,r=n.view.Login;return Object(p.b)("div",{css:Object(p.a)(Je())},Object(p.b)("div",{css:Object(p.a)(Ue())},Object(p.b)("img",{css:{height:300},src:"imgs/logo2.svg",alt:"logo"}),Object(p.b)(ze.a,{css:Object(p.a)(Ye()),onSubmit:r.login},Object(p.b)(Ge.a,{placeholder:"OADA Domain...",value:a.domain,onChange:function(e,t){return r.domainChange(t)}}),Object(p.b)(Ve.a,{style:{marginTop:7},primary:!0,loading:a.loading,disabled:a.loading},"Connect to Your OADA Cloud"),Object(p.b)(Ve.a,{style:{marginTop:7},onClick:r.viewDemo,disabled:a.loading},"View Demo"))),Object(p.b)("a",{css:Object(p.a)(He()),onClick:r.logout},"Logout"))},Qe=n(1102),Ke=n(1103),$e=(n(968),n(1075)),et=n(1076),tt=n(1077);function nt(){var e=Ze(),t=e.state,n=e.actions,a=t.view.Map.BoundaryDrawing,r=n.view.Map.BoundaryDrawing,o=a.boundary,s=a.drawing,i=r.onMarkerMove;return s?c.a.createElement($e.a,null,c.a.createElement(et.a,{positions:h.a.map(o)}),h.a.map(o,(function(e,t){return c.a.createElement(tt.a,{position:e,key:t,draggable:!0,onMove:function(e){var n=e.latlng,a=e.oldLatLng;return i({latlng:n,oldLatLng:a,id:t})}})}))):null}var at=n(1078);function rt(){var e=Ze(),t=e.state,n=e.actions,a=t.view.Map,r=n.view.Map,o=a.fields,s=r.onFieldClick;return 0==h.a.keys(o).length?null:c.a.createElement($e.a,null,h.a.map(o,(function(e,t){return c.a.createElement(at.a,{bubblingMouseEvents:!1,style:e.style,data:e.boundary,key:M()(),onClick:function(e){s({id:t})}})})))}function ot(){var e=Ze(),t=e.actions,n=e.state,a=t.view.Map,r=n.view.Map;return c.a.createElement(Qe.a,{bounds:r.bounds,center:[41.448068,-84.972648],zoom:13,onClick:function(e){return a.onMapClick(Object(k.a)({},e.latlng))},zoomControl:!1},c.a.createElement(Ke.a,{url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles \xa9 Esri \u2014 Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"}),c.a.createElement(nt,null),c.a.createElement(rt,null))}var ct=n(1087),st=n(1082),it=n(1079),ut=n(1083);function lt(){var e=Ze().actions.view.TopBar;return c.a.createElement(it.a,null,c.a.createElement(st.a,{style:{flex:1}}),c.a.createElement(ut.a,{color:"inherit",onClick:function(){return e.onCancelField()}},"Cancel"),c.a.createElement(ut.a,{color:"inherit",onClick:function(){return e.onSaveField()}},"Save"))}var dt=n(1098);function pt(e){var t=e.style,n=Ze(),a=n.actions,r=n.state,o=a.view.TopBar.OperationDropdown,s=r.view.TopBar.OperationDropdown,i=s.selectedOperation,u=s.list,l=s.open,d=s.search,p=o.onAdd,f=o.onChange,m=o.onOpenChange,v=o.onSearch;return c.a.createElement(st.a,{style:t},c.a.createElement(st.a,{style:{flexDirection:"row"}},i?c.a.createElement(dt.a,{open:l,onOpen:function(){m({open:!0})},onBlur:function(){m({open:!1})},text:i.name,icon:"cog",floating:!0,labeled:!0,button:!0,className:"icon"},c.a.createElement(dt.a.Menu,{style:{top:42}},c.a.createElement(dt.a.Item,{style:{textAlign:"center"},text:"Add New Operation",value:"Add New Operation",onClick:function(e,t){p()}}),c.a.createElement(Ge.a,{icon:"search",iconPosition:"left",className:"search",style:{marginTop:3},value:d,onChange:function(e){v({search:e.target.value})}}),c.a.createElement(dt.a.Menu,{scrolling:!0},h.a.map(u,(function(e){return c.a.createElement(dt.a.Item,Object.assign({key:e.value},e,{onClick:function(e,t){f({id:t.value})}}))}))))):c.a.createElement(dt.a,{onClick:function(){p()},open:!1,text:"Add New Operation",icon:"cog",floating:!0,labeled:!0,button:!0,className:"icon"}),c.a.createElement(st.a,{style:{flex:1}})))}var ft=n(150),ht=n(1084),mt=n(565),vt=n.n(mt),gt=n(1101),bt=n(1086);function wt(e){var t=e.style,n=Ze(),a=n.actions,r=n.state,o=a.view.TopBar,s=c.a.useState(null),i=Object(ft.a)(s,2),u=i[0],l=i[1];function d(){l(null)}return c.a.createElement(st.a,{style:t},c.a.createElement(ht.a,{edge:"end",color:"inherit","aria-label":"Menu",onClick:function(e){l(e.currentTarget)}},c.a.createElement(vt.a,null)),c.a.createElement(gt.a,{style:{top:50,right:5},open:Boolean(u),keepMounted:!0,anchorEl:u,onClose:d},c.a.createElement(bt.a,{onClick:function(){d(),o.onAddField()}},"Add Field"),r.view.FieldDetails.open?c.a.createElement(bt.a,{onClick:function(){d(),o.onEditField()}},"Edit Field"):null,c.a.createElement(bt.a,{onClick:function(){d(),o.onLogout()}},"Logout")))}function kt(e){e.toggleTitle;return c.a.createElement(it.a,null,c.a.createElement(pt,{style:{flex:1}}),c.a.createElement(wt,null))}function yt(){var e=Ze().state.view.Map.BoundaryDrawing.drawing;return c.a.createElement(st.a,{style:{zIndex:1201}},c.a.createElement(ct.a,{position:"static"},e?c.a.createElement(lt,null):c.a.createElement(kt,null)))}var xt=n(1100),Ot=n(1085),_t=n(1090),Dt=n(1031),Et=n(1088),At=n(1089),jt=n(341),Mt=n.n(jt),Ct=n(342),Ft=n.n(Ct);function St(){return c.a.createElement(xt.a,{open:!1,variant:"persistent"},c.a.createElement(st.a,{style:{height:64}}),c.a.createElement("div",{style:{width:250},role:"presentation"},c.a.createElement(Ot.a,null,["Inbox","Starred","Send email"].map((function(e,t){return c.a.createElement(Dt.a,{button:!0,key:e},c.a.createElement(Et.a,null,t%2===0?c.a.createElement(Mt.a,null):c.a.createElement(Ft.a,null)),c.a.createElement(At.a,{primary:e}))}))),c.a.createElement(_t.a,null),c.a.createElement(Ot.a,null,["All mail","Trash","Spam"].map((function(e,t){return c.a.createElement(Dt.a,{button:!0,key:e},c.a.createElement(Et.a,null,t%2===0?c.a.createElement(Mt.a,null):c.a.createElement(Ft.a,null)),c.a.createElement(At.a,{primary:e}))})))))}var It=n(1096),Nt=n(1092),Bt=n(1093),qt=n(1104),Tt=n(1091);function Rt(){var e=Ze(),t=e.state,n=e.actions,a=t.view.FieldDetails,r=n.view.FieldDetails,o=a.open,s=a.field,i=a.farm,u=a.showAddOperationButton,l=r.onStatusChange;r.onEditFieldClick,r.onAddNewOperationClick;return Boolean(s)||(o=!1,s={}),c.a.createElement(xt.a,{anchor:"bottom",open:o,variant:"persistent"},c.a.createElement(st.a,{style:{paddingBottom:20}},c.a.createElement(st.a,{style:{flexDirection:"column",alignItems:"center"}},c.a.createElement(st.a,{style:{justifyContent:"left",flexDirection:"row",alignItems:"center",marginTop:10}},c.a.createElement(Tt.a,{style:{fontWeight:"bold",fontSize:20}},s.name),c.a.createElement(Tt.a,{style:{marginLeft:7,fontSize:18}},"- ".concat(Math.round(s.acres)," ac"))),null==i?null:c.a.createElement(Tt.a,{style:{fontSize:15,color:"#999",marginTop:2,marginBottom:7}},i.name)),c.a.createElement(st.a,{style:{justifyContent:"center",flexDirection:"row"}},u?c.a.createElement(Ve.a,{style:{marginTop:15},onClick:function(){return r.onAddNewOperationClick()}},"Add New Operation"):c.a.createElement(qt.a,{component:"fieldset"},c.a.createElement(Nt.a,{"aria-label":"position",name:"position",row:!0},c.a.createElement(Bt.a,{value:"bottom",control:c.a.createElement(It.a,{color:"primary",checked:"planned"==s.status||!1,onChange:function(){l({status:"planned"})}}),label:"Planned",labelPlacement:"bottom"}),c.a.createElement(Bt.a,{value:"bottom",control:c.a.createElement(It.a,{color:"primary",checked:"started"==s.status||!1,onChange:function(){l({status:"started"})}}),label:"Started",labelPlacement:"bottom"}),c.a.createElement(Bt.a,{value:"bottom",control:c.a.createElement(It.a,{color:"primary",checked:"done"==s.status||!1,onChange:function(){l({status:"done"})}}),label:"Done",labelPlacement:"bottom"}))))))}function Pt(e){var t=e.acresStatus;return c.a.createElement(st.a,{style:{backgroundColor:"#c50003",paddingLeft:7,paddingRight:7,paddingTop:5,paddingBottom:5,borderRadius:5}},c.a.createElement(Tt.a,{style:{color:"white",textShadowColor:"#000",textShadowOffset:{width:1,height:1},textShadowRadius:2}},"".concat(t.planned," ac (").concat(t.plannedPercentage,"%)")))}function Lt(e){var t=e.acresStatus;return c.a.createElement(st.a,{style:{backgroundColor:"#eeb705",paddingLeft:7,paddingRight:7,paddingTop:5,paddingBottom:5,borderRadius:5,marginRight:7,marginLeft:7}},c.a.createElement(Tt.a,{style:{color:"white",textShadowColor:"#000",textShadowOffset:{width:1,height:1},textShadowRadius:2}},"".concat(t.started," ac (").concat(t.startedPercentage,"%)")))}function Wt(e){var t=e.acresStatus;return c.a.createElement(st.a,{style:{backgroundColor:"#5bb25f",paddingLeft:7,paddingRight:7,paddingTop:5,paddingBottom:5,borderRadius:5}},c.a.createElement(Tt.a,{style:{color:"white",textShadowColor:"#000",textShadowOffset:{width:1,height:1},textShadowRadius:2}},"".concat(t.done," ac (").concat(t.donePercentage,"%)")))}function Zt(){var e=Ze().state,t=e.app.acresStatus;return e.view.TopBar.OperationDropdown.selectedOperationId?c.a.createElement(st.a,{style:{position:"absolute",display:"flex",flexDirection:"row",justifyContent:"center",alignItems:"center",top:68,zIndex:401,width:"100vw"}},c.a.createElement(Pt,{acresStatus:t}),c.a.createElement(Lt,{acresStatus:t}),c.a.createElement(Wt,{acresStatus:t})):null}var zt=n(1095),Gt=n(129);function Vt(){var e=Ze(),t=e.state,n=e.actions,a=t.view.Modals.SaveField,r=n.view.Modals.SaveField,o=(a.open,a.name),s=r.onNameChange,i=r.onCancel,u=r.onSave,l=c.a.useState(!1),d=Object(ft.a)(l,2),p=d[0],f=d[1],h=a.farm||{},m=a.farms;return c.a.createElement(zt.a,{open:a.open,size:"tiny"},c.a.createElement(zt.a.Header,null,t.view.Map.editingField?"Edit Field":"New Field"),c.a.createElement(zt.a.Content,null,c.a.createElement(st.a,{style:{flexDirection:"column",zIndex:1}},c.a.createElement(Tt.a,{style:{marginBottom:7}},"Field Name:"),c.a.createElement(ze.a,{onSubmit:function(){return u()}},c.a.createElement(Ge.a,{autoFocus:!0,placeholder:"Back 40",value:o,onChange:function(e){s({name:e.target.value})}})),c.a.createElement(Tt.a,{style:{marginBottom:7,marginTop:15}},"Farm:"),c.a.createElement(dt.a,{trigger:c.a.createElement(st.a,{style:{paddingLeft:13,paddingRight:7,border:"1px solid rgba(34,36,38,.15)",borderRadius:".28571429rem",height:38,flexDirection:"row",alignItems:"center",justifyContent:"space-between"}},c.a.createElement(Tt.a,{style:{color:h.name?"rgba(0,0,0,.87)":"rgba(0,0,0,.25)"}},h.name||"Select a farm"),c.a.createElement(Gt.a,{name:"caret down",style:{paddingBottom:17}})),icon:null,onOpen:function(){f(!0)},onBlur:function(){f(!1)},open:p},c.a.createElement(dt.a.Menu,{style:{overflow:"hidden",maxHeight:"50vh"}},c.a.createElement(dt.a.Item,{style:{textAlign:"center"},text:"Add New Farm",value:"Add New Farm",onClick:function(e,t){r.onFarmAdd(),f(!1)}}),c.a.createElement(Ge.a,{icon:"search",iconPosition:"left",className:"search",value:a.farmSearch,onChange:function(e){r.onFarmSearchChange(e.target.value)}}),c.a.createElement(dt.a.Menu,{scrolling:!0},m.map((function(e){return c.a.createElement(dt.a.Item,Object.assign({key:e.value},e,{onClick:function(){r.onFarmChange({id:e.value}),f(!1)}}))}))))))),c.a.createElement(zt.a.Actions,null,c.a.createElement(Ve.a,{negative:!0,onClick:function(){return i()}},"Cancel"),c.a.createElement(Ve.a,{positive:!0,icon:"checkmark",labelPosition:"right",content:"Save",onClick:function(){return u()}})))}function Ht(){var e=Ze(),t=e.state,n=e.actions,a=t.view.Modals.OADADomain,r=n.view.Modals.OADADomain,o=a.open,s=a.domain,i=r.onDomainChange,u=r.onCancel,l=r.onConnect;return c.a.createElement(zt.a,{open:o,size:"tiny"},c.a.createElement(zt.a.Header,null,"Connect to OADA Server"),c.a.createElement(zt.a.Content,null,c.a.createElement(Tt.a,null,"Domain:"),c.a.createElement(st.a,{style:{flexDirection:"row"}},c.a.createElement(Ge.a,{style:{flex:1,marginTop:7},placeholder:"https://oada.openatk.com",value:s,onChange:function(e){i({domain:e.target.value})}}))),c.a.createElement(zt.a.Actions,null,c.a.createElement(Ve.a,{negative:!0,onClick:function(){return u()}},"Cancel"),c.a.createElement(Ve.a,{positive:!0,icon:"checkmark",labelPosition:"right",content:"Connect",onClick:function(){return l({})}})))}function Yt(){var e=Ze(),t=e.state,n=e.actions,a=t.view.Modals.NewOperation,r=n.view.Modals.NewOperation,o=a.open,s=a.name,i=r.onNameChange,u=r.onCancel,l=r.onSave;return c.a.createElement(zt.a,{open:o,size:"tiny"},c.a.createElement(zt.a.Header,null,"New Operation"),c.a.createElement(zt.a.Content,null,c.a.createElement(Tt.a,null,"Name:"),c.a.createElement(st.a,{style:{flexDirection:"row"}},c.a.createElement(ze.a,{style:{flex:1},onSubmit:l},c.a.createElement(Ge.a,{autoFocus:!0,style:{width:"100%",marginTop:7},placeholder:"Corn Planting",value:s,onChange:function(e){i({name:e.target.value})}})))),c.a.createElement(zt.a.Actions,null,c.a.createElement(Ve.a,{negative:!0,onClick:function(){return u()}},"Cancel"),c.a.createElement(Ve.a,{positive:!0,icon:"checkmark",labelPosition:"right",content:"Save",onClick:function(){return l()}})))}function Ut(){var e=Ze(),t=e.state,n=e.actions,a=t.view.Modals.NewFarm,r=n.view.Modals.NewFarm,o=a.open,s=a.name,i=r.onNameChange,u=r.onCancel,l=r.onSave;return c.a.createElement(zt.a,{open:o,size:"tiny"},c.a.createElement(zt.a.Header,null,"New Farm"),c.a.createElement(zt.a.Content,null,c.a.createElement(Tt.a,null,"Name:"),c.a.createElement(st.a,{style:{flexDirection:"row"}},c.a.createElement(Ge.a,{style:{flex:1,marginTop:7},placeholder:"Bowman Farms",value:s,onChange:function(e){i({name:e.target.value})}}))),c.a.createElement(zt.a.Actions,null,c.a.createElement(Ve.a,{negative:!0,onClick:function(){return u()}},"Cancel"),c.a.createElement(Ve.a,{positive:!0,icon:"checkmark",labelPosition:"right",content:"Save",onClick:function(){return l()}})))}var Jt=function(){return Ze().state.view.Login.loggedIn?c.a.createElement("div",{className:"App"},c.a.createElement(yt,null),c.a.createElement(Zt,null),c.a.createElement(ot,null),c.a.createElement(St,null),c.a.createElement(Rt,null),c.a.createElement(Vt,null),c.a.createElement(Ht,null),c.a.createElement(Yt,null),c.a.createElement(Ut,null)):c.a.createElement(Xe,null)},Xt=Object(z.c)(We,{devtools:!0});i.a.render(c.a.createElement(m.a,{value:Xt},c.a.createElement(Jt,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))},281:function(e,t){},535:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return{state:a.default,effects:o.default,actions:(0,r.default)(e)}};var a=c(n(812)),r=c(n(813)),o=c(n(816));function c(e){return e&&e.__esModule?e:{default:e}}},593:function(e,t,n){e.exports=n(1028)},598:function(e,t,n){},599:function(e,t,n){e.exports=n.p+"static/media/logo.5d5d9eef.svg"},600:function(e,t,n){},615:function(e,t){},617:function(e,t){},650:function(e,t){},651:function(e,t){},722:function(e,t){},812:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;t.default={connections:{}}},813:function(e,t,n){"use strict";var a=n(167);Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return l=e,{connect:function(e,t){var n=d(e),a=n.state,r=n.effects,o=t.connection_id||p(t.domain);return r.connect({connection_id:o,domain:t.domain,options:t.options,cache:t.cache,token:t.token,websocket:t.websocket}).then((function(e){return null==a[o]&&(a[o]={}),a[o].token=e.token,a[o].domain=t.domain,a[o].bookmarks&&(a[o].bookmarks={}),a.isAuthenticated=!0,{token:e.token,connectionId:o}})).catch((function(e){return a.error={error:e.message},a.isAuthenticated=!1,{error:e}}))},handleWatch:function(e,t){var n=d(e),a=n.state,r=(n.effects,null);if(t.nullPath&&((r=t.nullPath.split("/")).shift(),r.shift(),r=r.join(".")),"merge"===t.response.change.type){var o=c.default.get(a,"".concat(t.connection_id,".").concat(t.path)),s=c.default.cloneDeep(o);if(c.default.merge(o,t.response.change.body.data),t.response.change.wasDelete&&r){var i="".concat(t.path,".").concat(r);c.default.unset(a,"".concat(t.connection_id,".").concat(i))}return{oldState:s}}if("delete"===t.response.change.type){var u=c.default.cloneDeep(c.default.get(a,"".concat(t.connection_id,".").concat(t.path)));if(r){var l="".concat(t.path,".").concat(r);c.default.unset(a,"".concat(t.connection_id,".").concat(l))}return{oldState:u}}console.warn("oada-cache-overmind - UNKNOWN CHANGE TYPE:",t)},get:function(e,t){var n=d(e),o=n.state,s=n.effects,l=n.actions;if(!t.requests)throw new Error("Missing requests. Please pass requests in as an array of request objects under the requests key");var p=t.requests||[];return(t.concurrent?r.default.map:r.default.mapSeries)(p,(function(e,n){if(!e.complete){var r=e.path.replace(/^\//,"").split("/").join(".");if(e.watch){var d=o[e.connection_id||t.connection_id];if(d){if(d&&d.watches&&d.watches[e.path])return;e.watch.actions=[l.handleWatch].concat(a(e.watch.actions)),e.watch.payload=e.watch.payload||{},e.watch.payload.connection_id=e.connection_id||t.connection_id,e.watch.payload.path=r}}return s.get({connection_id:e.connection_id||t.connection_id,url:e.url,path:e.path,headers:e.headers,watch:e.watch,tree:e.tree||t.tree}).then((function(a){var s=a.data,i="".concat(e.connection_id||t.connection_id,".").concat(r);return s&&c.default.set(o,i,s),e.watch&&(i="".concat(e.connection_id||t.connection_id,".watches.").concat(e.path),c.default.set(o,i,!0)),p[n].complete=!0,a})).catch((function(e){return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({error:e},e.response)}))}})).then((function(e){return{responses:e,requests:p}}))},put:function(e,t){var n=d(e),a=n.state,o=n.effects;n.actions;if(!t.requests)throw new Error("Missing requests. Please pass requests in as an array of request objects under the requests key");var s=t.requests||[];return(t.concurrent?r.default.map:r.default.mapSeries)(s,(function(e,n){if(!e.complete)return o.put({url:e.url,path:e.path,data:e.data,type:e.type,headers:e.headers,tree:e.tree||t.tree,connection_id:e.connection_id||t.connection_id}).then((function(r){var o="".concat(e.connection_id||t.connection_id).concat(e.path.split("/").join(".")),i=c.default.cloneDeep(c.default.get(a,o)),u=c.default.merge(i,e.data);return c.default.set(a,o,u),s[n].complete=!0,r}))})).then((function(e){return{responses:e,requests:s}}))},post:function(e,t){var n=d(e),a=n.state,o=n.effects;n.actions;if(!t.requests)throw new Error("Missing requests. Please pass requests in as an array of request objects under the requests key");var s=t.requests||[];return(t.concurrent?r.default.map:r.default.mapSeries)(s,(function(e,n){if(!e.complete)return o.post({url:e.url,path:e.path,data:e.data,type:e.type,headers:e.headers,tree:e.tree||t.tree,connection_id:e.connection_id||t.connection_id}).then((function(r){r.headers.location;var o="".concat(e.connection_id||t.connection_id).concat(e.path.split("/").join(".")),i=c.default.cloneDeep(c.default.get(a,o)),u=c.default.merge(i,e.data);c.default.set(a,o,u),s[n].complete=!0}))})).then((function(e){return{responses:e}}))},delete:function(e,t){var n=d(e),a=n.state,o=n.effects;n.actions;if(!t.requests)throw new Error("Missing requests. Please pass requests in as an array of request objects under the requests key");var s=t.requests||[];return(t.concurrent?r.default.map:r.default.mapSeries)(s,(function(e,n){if(!e.complete){var r=e.connection_id||t.connection_id,i=e.path.replace(/^\//,"").split("/").join("."),u=c.default.get(a,r);if(!(e.unwatch&&u&&u.watches)||u.watches[e.path])return o.delete({connection_id:r,url:e.url,path:e.path,headers:e.headers,unwatch:e.unwatch,type:e.type,tree:e.tree||t.tree}).then((function(t){return e.unwatch&&u&&u.watches?c.default.unset(a,"".concat(r,".watches.").concat(e.path)):c.default.unset(a,"".concat(r,".").concat(i)),s[n].complete=!0,t}))}})).then((function(e){return{responses:e,requests:s}}))},disconnect:function(e,t){var n=d(e);n.state;return n.effects.disconnect({connection_id:t.connection_id})},resetCache:function(e,t){var n=d(e),a=n.effects;n.state;return a.resetCache({connection_id:t.connection_id||p(t.domain)})}}};var r=s(n(814)),o=s(n(92)),c=s(n(815));function s(e){return e&&e.__esModule?e:{default:e}}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}console.log("oada-cache-overmind: 1");var l=null;function d(e){return c.default.mapValues(e,(function(e){return null==l?e:c.default.get(e,l)}))}function p(e){return o.default.parse(e).hostname.replace(/\./g,"_")}},816:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=r(n(817));r(n(1029));function r(e){return e&&e.__esModule?e:{default:e}}var o={},c={connect:function(e){if(!e.connection_id)throw"connection_id not supplied";return e.connection_id&&o[e.connection_id]?Promise.resolve(o[e.connection_id]):a.default.connect(e).then((function(t){return t.cache={},o[e.connection_id]=t,t}))},get:function(e){if(!e.connection_id)throw"connection_id not supplied";if(e.watch&&e.watch.actions){var t=e.watch.actions;e.watch.func=function(e){t.forEach((function(t){t(e)}))}}return o[e.connection_id].get(e)},put:function(e){if(!e.connection_id)throw"connection_id not supplied";return o[e.connection_id].put(e)},post:function(e){if(!e.connection_id)throw"connection_id not supplied";return o[e.connection_id].post(e)},delete:function(e){if(!e.connection_id)throw"connection_id not supplied";return o[e.connection_id].delete(e)},resetCache:function(e){return o[e.connection_id].resetCache(e)},disconnect:function(e){if(!e.connection_id)throw"connection_id not supplied";var t=o[e.connection_id];return o[e.connection_id]=void 0,t.disconnect()}};t.default=c},817:function(e,t,n){(function(t){var a=n(10),r=n(101),o=n(210),c=n(818),s=n(837),i=n(302),u=n(92),l=n(460),d=n(839),p=n(845),f=n(862),h=n(211)("oada-cache:index:error"),m=n(211)("oada-cache:index:info"),v="";t.on("unhandledRejection",(function(e,t){console.log("------Unhandled Rejection - Fix Me!-------"),console.log(e)}));var g=function(){var e=r(a.mark((function e(t){var n,g,b,w,k,y,x,O,_,D,E,A,j,M,C,F,S,I,N,B,q,T,R,P,L,W,Z,z,G,V,H,Y,U,J,X,Q,K,$,ee,te,ne,ae,re,oe,ce,se,ie,ue,le;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(le=function(){return y?y._getMemoryCache():{}},ie=function(){return(ie=r(a.mark((function e(){return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,E.renew();case 2:D=e.sent;case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)},se=function(){return ie.apply(this,arguments)},ce=function(){return(ce=r(a.mark((function e(){return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y){e.next=3;break}return e.next=3,y.db.close();case 3:_&&_.close(),E.cleanUp();case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)},oe=function(){return ce.apply(this,arguments)},re=function(){return(re=r(a.mark((function e(t,n){return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(y){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,y.resetCache();case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)},ae=function(e,t){return re.apply(this,arguments)},ne=function(){return(ne=r(a.mark((function e(t){var n,r,o,c,s,d,p,f,h,m;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.url,r=t.path,o=t.data,c=t.type,s=t.headers,d=t.tree,e.next=3,N({method:"put",url:n,path:r,data:o,type:c,headers:s});case 3:if(p=e.sent,!d){e.next=11;break}return e.next=7,Y({url:p.url,tree:i.cloneDeep(d),data:o});case 7:f=e.sent,h=f.length>0?f[f.length-1].path.replace(/^\//,"").split("/"):u.parse(p.url).path.replace(/^\//,"").split("/"),m=H(h,d)+"/_type",!p.headers["content-type"]&&l.has(d,m)&&(p.headers["content-type"]=i.clone(l.get(d,m)));case 11:if(p.headers["content-type"]){e.next=14;break}throw new Error("content-type header must be specified.");case 14:return e.abrupt("return",q(p).then((function(e){return e})));case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)},te=function(e){return ne.apply(this,arguments)},ee=function(){return(ee=r(a.mark((function e(t){var n,r,o,c,s,i,d,p,f,h,m;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.url,r=t.path,o=t.type,c=t.headers,s=t.tree,i=t.unwatch,e.next=3,N({method:"delete",url:n,path:r,type:o,headers:c});case 3:if(d=e.sent,!i){e.next=7;break}return r=r||u.parse(n).path,e.abrupt("return",_.unwatch({path:r,headers:d.headers}));case 7:if(!s){e.next=17;break}if(p=u.parse(d.url).path.replace(/^\//,"").split("/"),f=H(p,s),l.has(s,f)){e.next=12;break}throw new Error("The path does not exist on the given tree.");case 12:return h=l.get(s,f),e.next=15,Q(d.url,h,{},!0);case 15:return m=e.sent,e.abrupt("return",m.link);case 17:if(d.headers["content-type"]){e.next=19;break}throw new Error("content-type header must be specified.");case 19:return e.abrupt("return",q(d));case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)},$=function(e){return ee.apply(this,arguments)},K=function(){return(K=r(a.mark((function e(t,n,c){var s;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n._type){e.next=11;break}return e.prev=1,e.next=4,W({url:t});case 4:s=e.sent,c=s.data,e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),404===e.t0.status&&(c={});case 11:return e.abrupt("return",o.map(Object.keys(c||{}),function(){var e=r(a.mark((function e(r){var o;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("object"!==typeof c[r]){e.next=20;break}if(!n[r]){e.next=8;break}return e.next=4,Q(t+"/"+r,n[r],c[r]);case 4:return o=e.sent,e.abrupt("return",c[r]=o.data);case 8:if(!n["*"]){e.next=17;break}return e.next=11,Q(t+"/"+r,n["*"],c[r]);case 11:return o=e.sent,m("url",t),m("recursiveDelete. returning",o.data),e.abrupt("return",c[r]=o.data);case 17:return e.abrupt("return");case 18:e.next=21;break;case 20:return e.abrupt("return");case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).then(r(a.mark((function e(){var r;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n._type){e.next=25;break}if(e.prev=1,!c._id){e.next=12;break}return e.prev=3,e.next=6,$({path:"/"+c._id,headers:{"content-type":n._type}});case 6:e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(3),h("aaaaaaaa","/"+c._id,t,e.t0),e.t0;case 12:return e.next=14,$({url:t,headers:{"content-type":n._type}});case 14:r=e.sent,e.next=23;break;case 17:if(e.prev=17,e.t1=e.catch(1),!e.t1.response||404!==e.t1.response.status){e.next=22;break}return c={},e.abrupt("return",{link:r||{},data:c||{}});case 22:throw e.t1;case 23:e.next=28;break;case 25:if(!y){e.next=28;break}return e.next=28,y.removeLookup({url:t});case 28:return e.abrupt("return",{link:r||{},data:c||{}});case 29:case"end":return e.stop()}}),e,null,[[1,17],[3,8]])})))));case 12:case"end":return e.stop()}}),e,null,[[1,8]])})))).apply(this,arguments)},Q=function(e,t,n){return K.apply(this,arguments)},X=function(e){var t=e.url,n=e.path,a=e.data,r=e.type,o=e.headers,c=e.tree;return t="/"===(t=t||A+n)[t.length-1]?t+s():t+"/"+s(),te({url:t,data:a,type:r,headers:o,tree:c})},J=function(e){var t=e.name,n=e.req,a=e.expires,r=c({name:t,req:n,expires:a,dbprefix:v});x=r.api,y=r},U=function(){return(U=r(a.mark((function e(t){var n,c,s,d,p,f,h,m,v,g;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.url,c=t.tree,s=t.data,d=u.parse(n).path.replace(/^\//,""),p=d.replace(/\/$/,"").split("/"),s._id&&(f=H(p,c),l.set(c,f+"/_id",s._id)),h={},m=[],e.next=8,V(p,c,h);case 8:return v=e.sent,g=v._rev,e.next=12,o.mapSeries(p.slice(0,p.length-v.stored),function(){var e=r(a.mark((function e(t,n){var r,o,s,u,d;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=v.stored+1+n,o="/"+p.slice(0,r+1).join("/"),s=H(p.slice(0,r+1),c),!(l.has(c,s+"/_type")&&r<=v.setup)){e.next=14;break}return e.next=6,C(l.get(c,s));case 6:return u=e.sent,e.next=9,F({path:o,data:i.cloneDeep(u),headers:{"if-match":g}});case 9:d=e.sent,g=d.resource.headers["x-oada-rev"],l.set(h,o,u),d.path=o,m.push(d);case 14:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}());case 12:return e.abrupt("return",m);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)},Y=function(e){return U.apply(this,arguments)},H=function(e,t){var n=i.clone(e);return"/"+(n=e.map((function(e,a){return l.has(t,"/"+n.slice(0,a).join("/")+"/*")?(n[a]="*","*"):e}))).join("/")},V=function(e,t,n){var a,r,c=0;return o.mapSeries(e,(function(o,s){var u=e.length-1-s,d="/"+e.slice(0,u+1).join("/"),p=H(e.slice(0,u+1),t);if(l.has(t,p+"/_type")){if(a=a||u,l.has(n,d))throw c=i.clone(u),new Error("stored");return W({path:d}).then((function(e){throw l.set(n,d,{}),c=i.clone(u),r=e.headers["x-oada-rev"],new Error("stored")})).catch((function(e){if(/^stored/.test(e.message))throw e}))}})).catch((function(e){if(/^stored/.test(e.message))return{stored:c,setup:a}})).then((function(){return{stored:c,setup:a||0,_rev:r}}))},G=function(){return(G=r(a.mark((function e(t,n,c,s){var i;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n._type){e.next=6;break}return e.next=3,W({url:t,headers:"_rev"in c?{"x-oada-rev":c._rev}:{}});case 3:i=e.sent,c=i.data,s=!!i.cached&&(i.cached&&s);case 6:return e.abrupt("return",o.map(Object.keys(c||{}),function(){var e=r(a.mark((function e(r){var o,i;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("object"!==typeof c[r]){e.next=20;break}if(!n[r]){e.next=9;break}return e.next=4,z(t+"/"+r,n[r],c[r],s);case 4:return o=e.sent,s=s&&o.cached,e.abrupt("return",c[r]=o.data);case 9:if(!n["*"]){e.next=17;break}return e.next=12,z(t+"/"+r,n["*"],c[r],s);case 12:return i=e.sent,s=s&&i.cached,e.abrupt("return",c[r]=i.data);case 17:return e.abrupt("return");case 18:e.next=21;break;case 20:return e.abrupt("return");case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).then((function(){return{data:c,cached:s}})));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)},z=function(e,t,n,a){return G.apply(this,arguments)},Z=function(){return(Z=r(a.mark((function e(t){var n,r,o,c,s,i,d,p,f,v,g,b,w;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.url,r=t.path,o=t.headers,c=t.watch,s=t.tree,e.next=3,N({method:"get",url:n,path:r,headers:o});case 3:return i=e.sent,e.next=6,q(i);case 6:if(p=e.sent,!s){e.next=14;break}if(v=u.parse(i.url).path.replace(/^\//,"").split("/"),g=H(v,s),m(s,g),l.has(s,g)){e.next=13;break}throw new Error("The path does not exist on the given tree.");case 13:f=l.get(s,g);case 14:if(!c){e.next=26;break}return r=r||u.parse(n).path,i.headers["x-oada-rev"]=p.data._rev,m("Setting watch. Sending rev:",p.data._rev),s&&(c.payload||(c.payload={}),c.payload.tree=f),(c.function||c.func)&&h("Deprecation warning: use callback to pass a watch handler."),(b=c.callback||c.function||c.func)||h("Warning: no watch handler was provided."),e.next=24,I({headers:i.headers,path:r,callback:b,payload:c.payload});case 24:d=e.sent,m("WATCH RESPONSE",d);case 26:if(!s){e.next=52;break}if(e.prev=27,!c||!d.resource){e.next=38;break}return e.next=31,z(i.url,f,d.resource,!0);case 31:return w=e.sent,h("tree getting",c,d.resource),e.next=35,z(i.url,f,d.resource,!0);case 35:w=e.sent,e.next=41;break;case 38:return e.next=40,z(i.url,f,p.data,!0);case 40:w=e.sent;case 41:p.data=w.data,p.cached=w.cached,e.next=52;break;case 45:if(e.prev=45,e.t0=e.catch(27),!e.t0.response||404!==e.t0.response.status){e.next=51;break}h("Received 404"),e.next=52;break;case 51:throw e.t0;case 52:return e.abrupt("return",p);case 53:case"end":return e.stop()}}),e,null,[[27,45]])})))).apply(this,arguments)},W=function(e){return Z.apply(this,arguments)},L=function(e,t,n){return o.map(Object.keys(n||{}),function(){var o=r(a.mark((function r(o){var c,s;return a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(!n[o]||"object"!==typeof n[o]){a.next=22;break}if(!t[o]){a.next=8;break}return a.next=4,L(e+"/"+o,t[o],n[o]);case 4:return c=a.sent,a.abrupt("return",n[o]=c.data);case 8:if(!t["*"]){a.next=15;break}return a.next=11,L(e+"/"+o,t["*"],n[o]);case 11:return c=a.sent,a.abrupt("return",n[o]=c.data);case 15:if(!n[o]._id){a.next=20;break}return s=!!n[o]._rev&&n[o]._rev,n[o]={_id:n[o]._id},s&&(n[o]._rev=n[o]._rev),a.abrupt("return");case 20:a.next=23;break;case 22:return a.abrupt("return");case 23:case"end":return a.stop()}}),r)})));return function(e){return o.apply(this,arguments)}}()).then((function(){return{data:n}}))},P=function(){return(P=r(a.mark((function e(t,n,c,s,i,u){var l;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i){e.next=6;break}return e.next=3,i(t,n,c,s);case 3:e.t0=e.sent,e.next=7;break;case 6:e.t0={data:c,obj:s};case 7:return l=e.t0,c=l.data,s=l.obj,m("mapping over data",t),e.abrupt("return",o.map(Object.keys(c||{}),function(){var e=r(a.mark((function e(r){var o,l;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(m("key is",r),m(typeof c[r],n),"object"!==typeof c[r]){e.next=19;break}if(!n[r]){e.next=7;break}o=n[r],e.next=12;break;case 7:if(!n["*"]){e.next=11;break}o=n["*"],e.next=12;break;case 11:return e.abrupt("return");case 12:return m("next data",c[r]),e.next=15,R(t+"/"+r,o,c[r],s,i,u);case 15:l=e.sent,m(r,l),c[r]=l.data,s=l.obj;case 19:return e.abrupt("return");case 20:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).then(r(a.mark((function e(){return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!u){e.next=6;break}return e.next=3,u(t,n,c,s);case 3:e.t0=e.sent,e.next=7;break;case 6:e.t0={data:c,obj:s};case 7:return e.abrupt("return",e.t0);case 8:case"end":return e.stop()}}),e)})))));case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)},R=function(e,t,n,a,r,o){return P.apply(this,arguments)},T=function(){return(T=r(a.mark((function e(t){return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.abrupt("return",x(t));case 4:if(e.prev=4,e.t0=e.catch(0),!e.t0||401!==e.t0.response.status){e.next=10;break}return e.next=9,se();case 9:return e.abrupt("return",x(t));case 10:throw e.t0;case 11:case"end":return e.stop()}}),e,null,[[0,4]])})))).apply(this,arguments)},q=function(e){return T.apply(this,arguments)},B=function(){return(B=r(a.mark((function e(t){var r,o,c,s,i,u,l;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.method,o=t.url,c=t.path,s=t.headers,i=t.data,u=t.type,c||o){e.next=3;break}throw new Error("Either path or url must be specified.");case 3:if(!o){e.next=10;break}if(!/^\//.test(o)){e.next=8;break}o=n+o,e.next=10;break;case 8:if(0===o.indexOf(n)){e.next=10;break}throw new Error("'url' key must begin with the domain used to connect");case 10:return r=r.toLowerCase(),/\/$/.test((l={method:r,url:o||A+c,headers:{authorization:"Bearer "+D}}).url)&&(l.url=l.url.slice(0,l.url.length-1)),Object.keys(s||{}).forEach((function(e){l.headers[e.toLowerCase()]=s[e]})),"put"!==r&&"post"!==r||(l.headers["content-type"]=l.headers["content-type"]||u||i._type,l.data=i),"delete"===r&&(l.headers["content-type"]=l.headers["content-type"]||u),l.requestStack=(new Error).stack,e.abrupt("return",l);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)},N=function(e){return B.apply(this,arguments)},I=function(e){var t=e.headers,n=e.path,o=e.callback,c=e.payload;if(_)return _.watch({path:n,headers:t},function(){var e=r(a.mark((function e(r){var s;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!c||!c.tree){e.next=8;break}return m("BODY BEFORE",n,c.tree),m(i.cloneDeep(r.change.body)),e.next=5,L(A+n,c.tree,r.change.body);case 5:r.change.body=e.sent,m("BODY AFTER"),m(r.change.body);case 8:if((s=i.cloneDeep(c)||{}).response=r,s.request={url:A+n,headers:t,method:r.change.type},e.prev=11,!y){e.next=16;break}return e.next=15,y.handleWatchChange(s);case 15:s=e.sent;case 16:e.next=22;break;case 18:throw e.prev=18,e.t0=e.catch(11),h(e.t0),e.t0;case 22:if(!o){e.next=25;break}return e.next=25,o(s);case 25:return e.abrupt("return");case 26:case"end":return e.stop()}}),e,null,[[11,18]])})));return function(t){return e.apply(this,arguments)}}());throw new Error("websocket is required to watch resource")},S=function(){return(S=r(a.mark((function e(t,n){var r,c,u,l,d,p,f,h,m,v,g;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.path,c=t.data,u=t.headers,c._id=i.clone(c._id)||"resources/"+s(),l={path:r,type:c._type,headers:u,data:{_id:c._id}},"_rev"in c&&(l.data._rev=0),d={path:"/"+c._id,type:c._type,data:c},e.prev=5,e.next=8,te(l);case 8:p=e.sent,e.next=51;break;case 11:if(e.prev=11,e.t0=e.catch(5),!e.t0.response||412!==e.t0.response.status){e.next=50;break}if(f=r.split("/"),h=f.splice(0,f.length-1).join("/"),!(n>16e3)){e.next=18;break}throw e.t0;case 18:return e.prev=18,e.next=21,O({method:"get",url:A+h,headers:{Authorization:"Bearer "+D}});case 21:m=e.sent,e.next=30;break;case 24:return e.prev=24,e.t1=e.catch(18),n=n||1e3,e.next=29,o.delay(n);case 29:return e.abrupt("return",F({path:r,data:c,headers:u},2*n));case 30:if(!m.data[f[f.length-1]]){e.next=42;break}if(d.data._id=m.data[f[f.length-1]]._id,d.path="/"+d.data._id,d.data._id){e.next=40;break}return n=n||1e3,e.next=37,o.delay(n);case 37:return(v=i.cloneDeep(u))["if-match"]=parseInt(m.headers["x-oada-rev"]),e.abrupt("return",F({path:r,data:c,headers:v},2*n));case 40:e.next=48;break;case 42:return n=n||1e3,e.next=45,o.delay(n);case 45:return(v=i.cloneDeep(u))["if-match"]=parseInt(m.headers["x-oada-rev"]),e.abrupt("return",F({path:r,data:c,headers:v},2*n));case 48:e.next=51;break;case 50:throw e.t0;case 51:return"_rev"in c&&delete d.data._rev,e.next=54,te(d);case 54:return g=e.sent,e.abrupt("return",{link:p,resource:g});case 56:case"end":return e.stop()}}),e,null,[[5,11],[18,24]])})))).apply(this,arguments)},F=function(e,t){return S.apply(this,arguments)},C=function(e){var t=Array.isArray(e)?[]:{};return e?o.map(Object.keys(e||{}),(function(n){if("*"!==n){var a=e[n];if("object"===typeof a&&a){if(!a._type)return a._id?(t[n]={_id:a._id},void("_rev"in a&&(t[n]._rev=a._rev))):C(a).then((function(e){t[n]=e}))}else t[n]=a}})).then((function(){return t})):e},n=t.domain,g=t.options,b=t.cache,w=t.token,k=t.websocket,n){e.next=37;break}throw new Error("domain undefined");case 37:if("string"===typeof n){e.next=39;break}throw new Error("domain must be a string");case 39:if(g||w){e.next=41;break}throw new Error("options and token undefined");case 41:if(!w||"string"===typeof w){e.next=43;break}throw new Error("token must be a string");case 43:if(void 0===b||"boolean"===typeof b||"object"===typeof b){e.next=45;break}throw new Error("cache must be either a boolean or an object with 'name' and/or 'expires' keys");case 45:if(!b||!b.name||"string"===typeof b.name){e.next=47;break}throw new Error("cache name must be a string");case 47:if("undefined"===typeof k||"boolean"===typeof k){e.next=49;break}throw new Error("websocket must be boolean");case 49:if(x=p,O=p,E=new f({domain:n,token:w,options:g,dbprefix:v}),n){e.next=54;break}throw new Error("domain undefined");case 54:return A=n,j=b&&b.name?b.name:u.parse(n).hostname.replace(/\./g,"_"),M=b&&b.expires?b.expires:void 0,e.next=59,E.get();case 59:if(D=e.sent){e.next=62;break}throw new Error("Unable to get token");case 62:if(!1===k){e.next=71;break}return e.next=65,d(n);case 65:return ue=e.sent,O=ue.http,x=ue.http,e.next=70,ue;case 70:_=e.sent;case 71:if(!1===b){e.next=74;break}return e.next=74,J({name:j||s(),req:x,expires:M});case 74:return e.abrupt("return",{token:D,cache:y||!1,websocket:_||!1,get:W,put:te,post:X,delete:$,resetCache:ae,disconnect:oe,reconnect:se,_getMemoryCache:le});case 75:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();e.exports={connect:g,setDbPrefix:function(e){return v=e}}}).call(this,n(25))},818:function(e,t,n){"use strict";var a=n(300),r=n(10),o=n(101),c=n(819),s=n(210),i=n(457);i.default&&(i=i.default);var u=n(92),l=n(302),d=n(460),p={};s.config({cancellation:!0});var f=n(211)("oada-cache:cache:error"),h=n(211)("oada-cache:cache:info");e.exports=function(e){var t,n=e.name,m=e.req,v=e.expires,g=e.dbprefix;n=(g=g||"")+n;var b=b||new i(n);i.on("destroyed",function(){var e=o(r.mark((function e(t){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t===n&&(b=new i(n));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());var w=m,k=v||1728e5;function y(e,t,n,a){var c=Date.now();return e in p?(p[e].data=t,p[e].access=c,p[e].valid=!0):p[e]={data:t,access:c,promise:void 0,putPending:!1,valid:!0},p[e].putPending||(p[e].putPending=!0,p[e].promise=s.delay(5e3).then(o(r.mark((function t(){return r.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e in p){t.next=2;break}throw new Error("Resource does not exist in the in-memory cache.");case 2:return t.next=4,x(e,n,a);case 4:p[e].putPending=!1;case 5:case"end":return t.stop()}}),t)})))).catch((function(t){throw f("handleMemoryCacheError",t),p[e].putPending=!1,t}))),s.resolve()}function x(e,t,n){if(p[e].data.doc)return b.put(p[e].data).then((function(t){p[e].data._rev=t.rev,delete p[e].promise})).catch((function(t){f("Error doPut",p[e].data._rev,t)}))}function O(e,t){return _.apply(this,arguments)}function _(){return(_=o(r.mark((function e(t,n){var a,o,c,s,i,f,h,m,v;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=u.parse(t.url),o=a.path.split("/"),c=o.slice(1,3).join("/"),s=o.length>3?"/"+o.slice(3,o.length).join("/"):"",i={_id:c,valid:void 0===t.valid||t.valid,accessed:Date.now(),doc:{}},f=p[c],h={doc:{}},f&&f.valid){e.next=23;break}return e.prev=8,e.next=11,b.get(c);case 11:h=e.sent,e.next=21;break;case 14:if(e.prev=14,e.t0=e.catch(8),!t.method||"delete"!==t.method.toLowerCase()){e.next=20;break}return e.abrupt("return");case 20:s&&(i.INCOMPLETE_RESOURCE=!0);case 21:e.next=25;break;case 23:void 0!==(h=f.data)._rev&&(i._rev=h._rev);case 25:if(!t.method||"delete"!==t.method.toLowerCase()){e.next=35;break}if(s){e.next=32;break}return p[c]&&p[c].promise&&p[c].promise.cancel(),delete p[c],e.abrupt("return",b.remove(h).then((function(e){return{response:e}})).catch((function(e){if(404!==e.status)throw e})));case 32:d.has(h.doc,s)&&(i.doc=h.doc,d.remove(i.doc,s));case 33:e.next=36;break;case 35:s?(m=d.has(h.doc,s)?d.get(h.doc,s):{},v=l.merge(m,t.data||{}),d.set(h.doc,s,v),i.doc=h.doc):i.doc=l.merge(h.doc,t.data);case 36:return void 0!=t._rev&&(i.doc._rev=t._rev),e.abrupt("return",y(c,i,n,t));case 38:case"end":return e.stop()}}),e,null,[[8,14]])})))).apply(this,arguments)}function D(e){return E.apply(this,arguments)}function E(){return(E=o(r.mark((function e(t){var n;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w({method:"GET",url:t.url,headers:t.headers});case 2:return(n=e.sent).cached=!1,t.data=n.data,e.next=7,O(t);case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function A(e){var t=u.parse(e.url),n=p[t.path];return n?n.data:b.get(t.path).catch(o(r.mark((function n(){var a,o,c,s,i,u;return r.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!e.resourceId){n.next=5;break}a=e.resourceId,o="",n.next=13;break;case 5:return(c=l.cloneDeep(e)).method="HEAD",n.next=9,w(c);case 9:s=n.sent,i=s.headers["content-location"].split("/"),a=i.slice(1,3).join("/"),o=i.length>3?"/"+i.slice(3,i.length).join("/"):"";case 13:return u={_id:t.path,resourceId:a,pathLeftover:o},n.abrupt("return",y(t.path,u,void 0,e).then((function(){return A(e)})));case 15:case"end":return n.stop()}}),n)}))))}function j(e){return M.apply(this,arguments)}function M(){return(M=o(r.mark((function e(t){var n,a,o,c,s,i,l,m,v,g,w,y=arguments;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=y.length>1&&void 0!==y[1]&&y[1],a=y.length>2?y[2]:void 0,o=u.parse(t.url),c=o.path.split("/"),s=c.slice(1,3).join("/"),i=c.length>3?"/"+c.slice(3,c.length).join("/"):"",l=void 0,void 0,(m=p[s])&&m.valid&&(l=m.data,h("Returning the resource [".concat(s,"] from in-memory cache."))),l){e.next=28;break}return e.prev=11,e.next=14,b.get(s);case 14:v=e.sent,l=v,h("Returning the resource [".concat(s,"] from PouchDB.")),g=Date.now(),p[s]={data:l,access:g,promise:void 0,putPending:!1,valid:l.valid},e.next=28;break;case 21:if(e.prev=21,e.t0=e.catch(11),404!==e.t0.status){e.next=27;break}f("Failed to get resource from PouchDB",e.t0),e.next=28;break;case 27:throw e.t0;case 28:if(l||n){e.next=33;break}return h("Returning the resource [".concat(s,"] from the remote server.")),e.abrupt("return",D(t));case 33:if(l||!n){e.next=35;break}throw"Offline and resource [".concat(s,"] not found in local db.");case 35:if(!(l.accessed+k<=Date.now()||!1===l.valid)){e.next=42;break}if(!n){e.next=40;break}throw new Error("Cached resource is expired or invalid and unable to fetch from the remote server.");case 40:return h("Resource is expired or invalid. Returning the resource [".concat(s,"] from the remote server.")),e.abrupt("return",D(t));case 42:if(!(t.headers&&t.headers["x-oada-rev"]&&parseInt(t.headers["x-oada-rev"])-parseInt(l.doc._rev)>=a)){e.next=44;break}return e.abrupt("return",D(t));case 44:if(!d.has(l.doc,i)){e.next=49;break}return w=d.get(l.doc,i),e.abrupt("return",{data:w,headers:{"x-oada-rev":l.doc._rev,"content-location":s+i},status:200,cached:!0});case 49:return e.abrupt("return",D(t));case 50:case"end":return e.stop()}}),e,null,[[11,21]])})))).apply(this,arguments)}function C(){return(C=o(r.mark((function e(t,n){var a,o,c;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=u.parse(t.url),o=l.cloneDeep(t),/^\/resources/.test(a.path)&&/^\/users/.test(a.path)){e.next=7;break}return e.next=5,A(t);case 5:c=e.sent,o.url=a.protocol+"//"+a.host+"/"+c.resourceId+c.pathLeftover;case 7:return e.abrupt("return",j(o,!1,n||10).then((function(e){return e})));case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function F(){return(F=o(r.mark((function e(t){var n,a,o,c=arguments;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=c.length>1&&void 0!==c[1]&&c[1],a=u.parse(t.url),!n){e.next=8;break}return e.next=5,A({url:a.protocol+"//"+a.host+reqPieces.slice(0,reqPieces.length-1).join("/"),headers:t.headers});case 5:e.sent,e.next=15;break;case 8:return e.next=10,w(t);case 10:return o=e.sent,e.next=13,O({url:o.headers["content-location"],data:t.data,_rev:parseInt(o.headers["x-oada-rev"]),valid:!1});case 13:return t.data&&t.data._id&&p[t.data._id]&&(p[t.data._id].valid=!1),e.abrupt("return",o);case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function S(e){return I.apply(this,arguments)}function I(){return(I=o(r.mark((function e(t){var n,a,o;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=u.parse(t.url),a=n.path.split("/"),e.next=4,A({url:n.protocol+"//"+n.host+a.slice(0,a.length-1).join("/"),headers:t.headers});case 4:return o=e.sent,e.prev=5,e.next=8,O({url:"/"+o.resourceId+o.pathLeftover+"/"+a[a.length-1],method:"delete",valid:!1});case 8:e.next=13;break;case 10:throw e.prev=10,e.t0=e.catch(5),e.t0;case 13:return e.abrupt("return");case 14:case"end":return e.stop()}}),e,null,[[5,10]])})))).apply(this,arguments)}function N(e){return B.apply(this,arguments)}function B(){return(B=o(r.mark((function e(t){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p[t._id]&&(p[t._id].promise&&p[t._id].promise.cancel(),delete p[t._id]),e.prev=1,e.next=4,b.remove(t);case 4:e.next=13;break;case 6:if(e.prev=6,e.t0=e.catch(1),404!==e.t0.status){e.next=12;break}return e.abrupt("return");case 12:throw e.t0;case 13:case"end":return e.stop()}}),e,null,[[1,6]])})))).apply(this,arguments)}function q(){return(q=o(r.mark((function e(t,n){var a,o,c;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=u.parse(t.url),!/^\/resources/.test(a.path)&&!/^\/users/.test(a.path)){e.next=6;break}return e.next=4,O({url:t.url,method:t.method,valid:!1});case 4:e.next=25;break;case 6:return e.prev=6,e.next=9,A(t);case 9:if(!(o=e.sent).pathLeftover){e.next=15;break}return e.next=13,O({url:"/"+o.resourceId+o.pathLeftover,method:t.method,valid:!1});case 13:e.next=17;break;case 15:return e.next=17,S(t);case 17:return e.next=19,N(o);case 19:e.next=25;break;case 21:if(e.prev=21,e.t0=e.catch(6),404===e.t0.response.status){e.next=25;break}throw e.t0;case 25:if(n){e.next=29;break}return e.next=28,w(t);case 28:c=e.sent;case 29:return e.abrupt("return",c);case 30:case"end":return e.stop()}}),e,null,[[6,21]])})))).apply(this,arguments)}function T(e,t){var n=Array.isArray(e)?[]:{};return e?(Object.keys(e||{}).forEach(function(){var a=o(r.mark((function a(o,c){var s,i;return r.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if("object"===typeof(s=e[o])&&s){a.next=4;break}return n[o]=s,a.abrupt("return");case 4:if(!s._meta){a.next=11;break}return a.next=7,A({url:t.url+"/"+o,headers:t.headers});case 7:return i=a.sent,n[o]={_id:i.resourceId},void 0!==e[o]._rev&&(n[o]._rev=e[o]._rev),a.abrupt("return");case 11:n[o]=T(e[o],{url:t.url+"/"+o,headers:t.headers});case 12:case"end":return a.stop()}}),a)})));return function(e,t){return a.apply(this,arguments)}}()),n):e}function R(e,t){return P.apply(this,arguments)}function P(){return(P=o(r.mark((function e(t,n){var a,c;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n._rev){e.next=7;break}return e.next=3,A({url:t.url,headers:t.headers,resourceId:n._id});case 3:return a=e.sent,c=T(n,{url:t.url,headers:t.headers}),e.next=7,O({url:"/"+(n._id||a.resourceId),data:c});case 7:if("object"!==typeof n){e.next=11;break}return e.abrupt("return",s.map(Object.keys(n||{}),function(){var e=o(r.mark((function e(a){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("_"!==a.charAt(0)){e.next=2;break}return e.abrupt("return");case 2:if(n[a]){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,R({url:t.url+"/"+a,headers:t.headers},n[a]);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 11:return e.abrupt("return");case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function L(e,t,n){return"object"===typeof e?s.map(Object.keys(e||{}),(function(a){return null===e[a]?n=t+"/"+a:L(e[a],t+"/"+a,n).then((function(e){return n=e||n,e||n}))}),{concurrency:1}).then((function(){return n})):s.resolve()}function W(e,t,n){return"object"===typeof e?s.map(Object.keys(e||{}),(function(a){if("_rev"===a)n.path=t,n.data=e;else if("_"===a.charAt(0))return n;return W(e[a],t+"/"+a,n).then((function(){return n}))})).then((function(){return n})):s.resolve(n)}setInterval((function(){var e=Date.now(),t={key:void 0,time:e},n=0;Object.keys(p).forEach((function(a){!p[a].putPending&&e-p[a].access<3e4&&(p[a].access<t&&(t={key:a,time:p[a].access}),delete p[a],h("Deleted expired resource from the in-memory cache",a),n++)})),0===n&&t.key&&delete p[t.key]}),1e4);var Z=c().limit({concurrency:1}).process(function(){var e=o(r.mark((function e(t){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u.parse(t.request.url),t.response.change.body=t.response.change.body||{},t.response.change.body._id=t.response.resourceId,e.abrupt("return",W(t.response.change.body,"",{path:"",data:t.response.change.body}).then(function(){var e=o(r.mark((function e(n){var a,c;return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.response.change.wasDelete){e.next=9;break}return e.next=3,L(n.data,"","");case 3:return a=e.sent,c=n.path+a,t.nullPath=c,e.abrupt("return",O({url:t.request.url+c,headers:t.request.headers,method:"delete",valid:!0}).then(o(r.mark((function e(){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t);case 1:case"end":return e.stop()}}),e)})))));case 9:return e.next=11,R(t.request,t.response.change.body.data);case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){return t})));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());function z(){return(z=o(r.mark((function e(t){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!b){e.next=5;break}return Object.keys(p).forEach(function(){var e=o(r.mark((function e(t){return r.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!p[t].promise){e.next=3;break}return e.next=3,p[t].promise.cancel();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),p={},e.next=5,b.destroy();case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}return a(t={api:function(e){switch(e.method){case"get":return function(e,t){return C.apply(this,arguments)}(e);case"delete":return function(e,t){return q.apply(this,arguments)}(e);case"put":return function(e){return F.apply(this,arguments)}(e);default:throw new Error("Unknown request method.")}},db:b,resetCache:function(e){return z.apply(this,arguments)},handleWatchChange:function(e){return Z(e)},removeLookup:N,findDeepestResource:W,findNullValue:L,getLookup:A,dbUpsert:O,handleMemoryCache:y,doPut:x,_recursiveUpsert:R},"findNullValue",L),a(t,"replaceLinks",T),a(t,"updateParent",S),a(t,"getResFromDb",j),a(t,"getResFromServer",D),a(t,"_getMemoryCache",(function(){return p})),t}},839:function(e,t,n){var a=n(450),r=n(300),o=n(840),c=n(210),s=n(92),i=n(463),u=n(844);c.config({warnings:!1}),e.exports=function(e){var t=[];e=e.replace("https://","wss://").replace("http://","ws://");var n=new u(e),l=!1,d={},p={};function f(){l&&(t.forEach((function(e){n.send(JSON.stringify(e))})),t=[])}return new c((function(e,t){n.onopen=function(t){l=!0,f(),e(n)},n.oncloconsose=function(e){},n.onmessage=function(e){var t=JSON.parse(e.data);if(t.requestId)if(d[t.requestId]){if(t.status>=200&&t.status<300)d[t.requestId].resolve(t);else{var n=new Error("Request failed with status code "+t.status);n.request=d[t.requestId].request,n.response={status:t.status,statusText:t.statusText,headers:t.headers,data:t.data},n.originalStack=d[t.requestId].request.requestStack,d[t.requestId].reject(n)}delete d[t.requestId]}else if(p[t.requestId])if(p[t.requestId].resolve){if("success"===t.status)p[t.requestId].resolve(t);else{var a=new Error("Request failed with status code "+t.status);a.response=t,a.request=p[t.requestId].request,p[t.requestId].reject(a)}delete p[t.requestId].resolve,delete p[t.requestId].reject}else{if(null==p[t.requestId].callback)throw new Error("The given watch function has an undefined callback:",p[t.requestId]);p[t.requestId].callback(t)}}})).then((function(){return{url:e,http:function(e){return new c((function(n,c){var u=s.parse(e.url),l={requestId:i(),method:e.method.toLowerCase(),path:u.path,data:e.data,headers:Object.entries(e.headers).map((function(e){var t=o(e,2),n=t[0],a=t[1];return r({},n.toLowerCase(),a)})).reduce((function(e,t){return a({},e,{},t)}))};t.push(l),d[l.requestId]={request:e,resolve:n,reject:c},f()}))},close:function(){t=[],d={},p={},n.close()},watch:function(e,n){return new c((function(c,s){var u={requestId:i(),method:"watch",path:e.path,headers:Object.entries(e.headers).map((function(e){var t=o(e,2),n=t[0],a=t[1];return r({},n.toLowerCase(),a)})).reduce((function(e,t){return a({},e,{},t)}))};t.push(u),p[u.requestId]={request:e,resolve:c,reject:s,callback:n},f()}))},unwatch:function(e,n){return new c((function(c,s){var u={requestId:i(),method:"unwatch",path:e.path,headers:Object.entries(e.headers).map((function(e){var t=o(e,2),n=t[0],a=t[1];return r({},n.toLowerCase(),a)})).reduce((function(e,t){return a({},e,{},t)}))};t.push(u),p[u.requestId]={request:e,resolve:c,reject:s,callback:n},f()}))}}}))}},862:function(e,t,n){"use strict";var a=n(10),r=n(101),o=n(863),c=n(864),s=n(210),i=n(457);i.default&&(i=i.default);n(453).STATUS_CODE;var u=n(92),l=(n(302),n(195)),d=n(865),p=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o(this,e);var n=this;n._token=t.token||null,n._domain=t.domain||"localhost",n._options=t.options,n._dbprefix=t.dbprefix||"";var a=l.createHash("sha256");a.update(n._domain),n._name=n._dbprefix+a.digest("hex"),n._isSet=!!n._token,n._tokenDB=new i(n._name),n._id="OadaTokenID",n._rev=null,n.token=n._token?n._token:""}return c(e,[{key:"checkTokenDB",value:function(){var e=r(a.mark((function e(){var t,n;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=null,e.prev=1,e.next=4,this._tokenDB.get(this._id);case 4:n=e.sent,t=n.token,this._rev=n._rev,e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(1),e.abrupt("return",t);case 12:return e.abrupt("return",t);case 13:case"end":return e.stop()}}),e,this,[[1,9]])})));return function(){return e.apply(this,arguments)}}()},{key:"setup",value:function(){var e=r(a.mark((function e(t){var n,r,o,c;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=null,!this.isSet()){e.next=5;break}n=this.token,e.next=22;break;case 5:return e.next=7,this.checkTokenDB();case 7:if((n=e.sent)&&!t){e.next=22;break}if(r=u.parse(this._domain),"undefined"!==typeof window){e.next=16;break}return e.next=13,d.node(r.host,this._options);case 13:o=e.sent,e.next=20;break;case 16:return c=s.promisify(d.getAccessToken),e.next=19,c(r.host,this._options);case 19:o=e.sent;case 20:n=o.access_token,this.put(n);case 22:return e.abrupt("return",n);case 23:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=r(a.mark((function e(){return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setup());case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"put",value:function(){var e=r(a.mark((function e(t){var n;return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.checkTokenDB(),e.prev=1,!n){e.next=9;break}return e.next=5,this._tokenDB.put({_id:this._id,_rev:this._rev,token:t});case 5:e.sent,this.token=t,e.next=13;break;case 9:return e.next=11,this._tokenDB.put({_id:this._id,token:t});case 11:e.sent,this.token=t;case 13:e.next=17;break;case 15:e.prev=15,e.t0=e.catch(1);case 17:case"end":return e.stop()}}),e,this,[[1,15]])})));return function(t){return e.apply(this,arguments)}}()},{key:"renew",value:function(){var e=r(a.mark((function e(){return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._isSet=!1,e.abrupt("return",this.setup(!0));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"cleanUp",value:function(){var e=r(a.mark((function e(){return a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._tokenDB.destroy();case 3:this._isSet=!1,e.next=8;break;case 6:e.prev=6,e.t0=e.catch(0);case 8:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(){return e.apply(this,arguments)}}()},{key:"isSet",value:function(){return this._isSet}}]),e}();e.exports=p},968:function(e,t,n){}},[[593,1,2]]]);
//# sourceMappingURL=main.29deb198.chunk.js.map